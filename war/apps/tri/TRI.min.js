/*
 @license
 Copyright (c) 2013 by Steve Pritchard of Rexcel Systems Inc.
 This file is made available under the terms of the Creative Commons Attribution-ShareAlike 3.0 license
 http://creativecommons.org/licenses/by-sa/3.0/.
 Contact: public.pritchard@gmail.com
*/
(function(){"use strict"})();var oApp=angular.module("app",[],function($rootScopeProvider){$rootScopeProvider.digestTtl(10);if(oGBL){log("app module has been built templates="+(oGBL.templates?oGBL.templates.length:0))}});hookMsgListener();var oGBL={msgHandler:{},optTables:[]};function hookMsgListener(){var oNoTmps=document.getElementById("body-no-templates");var sHtml=null;log("Hooked message listener app=%o notmps=%o",oApp,oNoTmps);window.addEventListener("message",function(event){if(""+event.origin=="http://disqus.com")return;log("messageEvent origin "+event.origin);log("messageEvent ",event);if(event.data.verb){if(event.data.verb=="sys-templates"){log("have sys-templates "+event.data.payload.length,event.data);oGBL.templates=event.data.payload;var oCust=document.getElementById("cust-templates");if(oCust){var oPREs=angular.element(oCust).find("pre");log("  children %o find %o",angular.element(oCust),angular.element(oCust).find("pre"));var oTMPs=oGBL.templates;for(var i=0,iMax=oPREs.length;i<iMax;i+=1){var oPRE=oPREs.eq(i);if(!oPRE.hasClass("template"))continue;var sID=oPRE.attr("id");sHtml=oPRE.html();var oTMP={id:sID,html:sHtml};oTMPs.push(oTMP)}}log("Issue Angular bootstrap");angular.bootstrap(angular.element(document).find("body"),["app"]);return}else if(event.data.verb=="sys-close-page"){event.source.close()}else if(event.data.verb=="sys-get-template"){sHtml=oGBL.$templateCache.get(event.data.payload.name);var oPL=event.data.payload;var oMsg={verb:"sys-put-template",payload:{name:oPL.name,html:sHtml,id:oPL.id}};event.source.postMessage(oMsg,"*")}else if(event.data.verb=="sys-put-template"){tri.postTemplate(event)}else{var sPref=event.data.verb.match(/^([^:]+)/)[1];if(oGBL.msgHandler[sPref]){oGBL.msgHandler[sPref](event)}else{log("spurious sys: messageEvent verb=%s pref=%s evt=%o",event.data.verb,sPref,event)}}}else{log("tri.js spurious messageEvent ",event)}},false)}function Col(props){for(var i in props){this[i]=props[i]}if(!this.type){if(typeof this.col=="function"){this.type="virt"}else{this.type="field"}}Col.nNextCid+=1;this.cid=Col.nNextCid;Col.oCidMap[this.cid]=this}Col.nNextCid=0;Col.oCidMap={};Col.getCol=function(cid){return Col.oCidMap[cid]};Col.asObjects=function(oCols){if(oCols[0].cid)return oCols;var oNew=[];for(var i=0;i<oCols.length;i+=1){oNew[i]=new Col(oCols[i]);if(oNew[i].schema)oNew[i].schema.cols=Col.asObjects(oNew[i].schema.cols)}return oNew};Col.prototype=function(){return{constructor:Col,getTitle:getTitle,getField:getField,getID:getID,select:select,getValue:getValue,getActions:getActions,getListHint:getListHint,getHint:getHint,getPlace:getPlace,action:action};function getTitle(){if(this.title)return this.title;return""+this.col}function getField(){if(this.field)return this.field;if(this.type!="virt")return this.col;return"_field_"}function getHint(scope){if(!this.hint)return"";if(typeof this.hint=="function"){return this.hint(scope,this)}else{return""+this.hint}}function getListHint(scope,oObj){if(!this.listHint)return"";return this.listHint(scope,oObj,this)}function getPlace(scope){if(!this.place)return"";if(typeof this.place=="function"){return this.place(scope,this)}else{return""+this.place}}function getID(){return(""+getTitle.call(this)).replace(/ /,"-")}function getActions(scope,oObj){var i,iMax;if(this.type!="actions")return[];if(!this.oActs){this.oActs=[];if(!this.actions||this.addDefault){this.oActs=[{label:"edit",click:"editRecord(oRow.oaa)",title:""},{label:"drop",click:"dropRecord(oRow.oaa)",title:""}]}if(this.actions){var oProf=scope.oServSess.getProfile();log("add custom actions prof=%o actions=%o",oProf,this.actions);if(oProf)for(i=0,iMax=this.actions.length;i<iMax;i+=1){var oAct=this.actions[i];if(oAct.role){if(oProf.role&&oProf.role.indexOf(oAct.role)>=0)this.oActs.push(oAct)}else{this.oActs.push(oAct)}}}log("oActs length %o"+this.oActs.length,{array:this.oActs})}for(i=0,iMax=this.oActs.length;i<iMax;i+=1){var oA=this.oActs[i];if(oA.method){scope[getFuncName(oA.method)]=oA.method}if(oA.methClass){scope[getFuncName(oA.methClass)]=oA.methClass}if(oA.click)scopeAddMethod(scope,oA.click);if(oA.whatClass)scopeAddMethod(scope,oA.whatClass)}return this.oActs}function scopeAddMethod(scope,sMeth){if(!this)return;var oR=sMeth.match(/^([^(]+)/);if(oR){if(typeof this[oR[1]]=="function"){scope[oR[1]]=this[oR[1]]}}}function action(scope,oMeth,oObj){log("action called "+oMeth)}function select(scope,oCols,sType){if(sType==null){oCols.push(this)}else if(sType=="=edit"){if(this.type=="virt"||this.type=="action"||this.type=="list"||this.type=="actions"){if(showEdit(this,false))oCols.push(this)}else{if(showEdit(this,true)){oCols.push(this)}}}else if(sType=="=list"){if(this.type!="list"){if(!("showList"in this)||this.showList){oCols.push(this)}}}else if(sType=="=cust"){if("showCust"in this&&this.showCust)oCols.push(this)}else{if(sType==this.type)oCols.push(this)}function showEdit(oCol,bDef){if(!("showEdit"in oCol))return bDef;if(!oCol.showEdit)return false;if(typeof oCol.showEdit=="function")return oCol.showEdit(scope,scope.oObj);return true}}function getValue(scope,oObj,nMax){if(!oObj)return null;try{var sVal="";if(typeof this.col=="function"){sVal=this.col(oObj,scope,this)}else{if(this.type=="method"){return"<a href=''>method</a>"}sVal=""+oObj[this.col]}if(angular.isNumber(nMax)){if(sVal.length>nMax){sVal=sVal.substring(0,nMax-4)+" ..."}}return sVal}catch(e){log("getValue failed "+e+" col=%o obj=%o scope=%o",this,oObj,scope)}}}();function Table(props,scope,oCRUD){var i,iMax;for(i in props){this[i]=props[i]}this.props=this.getTabProp();this.props.oCRUD=oCRUD;if(!this.props.oSel)this.props.oSel={};this.scope=scope||null;if(this.scope){this.scope.oSel=this.props.oSel;log("oSel ptr established "+this.scope.$id,this.props.oSel)}if(!this.props.bMigrated){this.props.bMigrated=true;this.props.cols=Col.asObjects(this.props.cols);if(!this.props.filters)this.props.filters=[];if(this.props.filters.length===0||this.props.filters[0].type!="limit"){this.props.filters.unshift({type:"limit",init:50,title:"Limit",name:"_limit"})}for(i=0,iMax=this.props.filters.length;i<iMax;i+=1){this.props.filters[i]=new Filter(this.props.filters[i]).normalize(this)}}}Table.prototype=function(){return{constructor:Table,getTitle:getTitle,toString:toString,getFilters:getFilters,getObjs:getObjs,getSelObjs:getSelObjs,findCol:findCol,getTableCols:getTableCols,getEditActions:getEditActions,getOptActions:getOptActions};function getTitle(){if(this.props.recTitle)return this.props.recTitle;return"?table?"}function getFilters(sType){var oFils=[];if(!this.props.selector||!this.props.selector._filters)return oFils;for(var i in this.props.selector._filters){var oFil=this.props.selector._filters[i];if(!sType||oFil.type==sType){oFils.push(oFil)}}return oFils}function getOptActions(scope){if(!this.props.optActions)return[];log("get OptActions %o"+this.props.recTitle,this.props.optActions);return hookOptActions(this,this.props.optActions,scope)}function hookOptActions(oThis,oActs,scope){for(var i=0,iMax=oActs.length;i<iMax;i+=1){var oA=oActs[i];if(oA.click)scopeAddMethod(oThis,scope,oA.click);if(oA.whatClass)scopeAddMethod(oThis,scope,oA.whatClass)}return oActs}function scopeAddMethod(oThis,scope,sMeth){log("Hooking "+sMeth+" to "+scope.$id+" this=%o",oThis);var oR=sMeth.match(/^([^(]+)/);if(oR){if(typeof oThis[oR[1]]=="function"){scope[oR[1]]=oThis[oR[1]]}}}function getEditActions(scope,oObj){if(!this.props.editActions)return[];if(this.props.editActions.oActs&&this.props.editActions.oEditObj==oObj)return this.props.editActions.oActs;this.props.editActions.oActs=[];this.props.editActions.oEditObj=oObj;for(var i=0,iMax=this.props.editActions.length;i<iMax;i+=1){var oDef=this.props.editActions[i];var oA={click:getFuncName(oDef.click)+"(this,oObj,$event)"};scope[getFuncName(oDef.click)]=oDef.click;if(typeof oDef.text=="function"){oA.text=oDef.text(scope,oObj)}else{oA.text=oDef.text}this.props.editActions.oActs.push(oA)}return this.props.editActions.oActs}function getObjs(){var oTP=this.props;return oTP.oCRUD.getObjs(oTP)}function getSelObjs(){var oTP=this.props;var oObjs=oTP.oCRUD.getObjs(oTP);var oData=this.props.oSel;oData._objs=oObjs.length;if(angular.equals(this.props.oPrevSel,oData)){return this.props.oPrevSelObjs}this.props.oPrevSel=angular.copy(oData);log("Select "+oTP.recTitle+" objects max="+oObjs.length+" filters="+oTP.filters.length+" data=%o objs=%o",oData,{array:oObjs});if(!oData)return oObjs;for(var i in oTP.filters){var oFil=oTP.filters[i];if(oFil.type=="mask")oObjs=maskReduce.call(this,oObjs,oData,oFil);if(oFil.type=="state")oObjs=stateReduce.call(this,oObjs,oData,oFil);if(oFil.methCust){var oMeth=oFil.methCust;oObjs=oMeth(this,oObjs,oData,oFil)}}if("_limit"in oData){if(oObjs.length>oData._limit)oObjs=oObjs.slice(0,oData._limit)}log("  selected %i objs=%o",oObjs.length,{array:oObjs});this.props.oPrevSelObjs=oObjs;return oObjs}function findCol(sCol){var oTP=this.props;for(var i in oTP.cols){var oCol=oTP.cols[i];if(oCol.col===sCol)return oCol}return null}function getTableCols(sType){var oTP=this.props;if(!oTP)return[];if(!oTP.cols)return[];return iterateCols.call(this,this.scope,oTP.cols,sType)}function maskReduce(oObjs,oData,oFil){var oCol=findCol.call(this,oFil.field);if(oCol==null)return oObjs;var sMask=oData[oFil.field];if(!sMask||""+sMask.trim()==="")return oObjs;var oMask=new RegExp(sMask,"i");var oNewObjs=[];for(var i in oObjs){var oRec=oObjs[i];var sFld=oCol.getValue(null,oRec);if((""+sFld).match(oMask)!=null){oNewObjs.push(oRec)}}return oNewObjs}function stateReduce(oObjs,oData,oFil){var oCol=findCol.call(this,oFil.field);if(!oData[oFil.field])return oObjs;var oStat=oData[oFil.field].status;if(!oStat){log("no status field");return oObjs}if(oStat.open)return[];if(oStat.list.length===0)return oObjs;var oNewObjs=[];var oMap={};for(var j in oStat.list){var sVal=oStat.list[j];var sOptVal=oStat.tri[0].options[sVal].value;oMap[sOptVal]=true}for(var i in oObjs){var oRec=oObjs[i];var sFld=oRec[oFil.field];if(oStat.mode=="INCL"){if(oMap[sFld])oNewObjs.push(oRec)}else{if(!oMap[sFld])oNewObjs.push(oRec)}}return oNewObjs}function iterateCols(scope,oColDefns,sType){var oCols=[];for(var i in oColDefns){var oCol=oColDefns[i];oCol.select(scope,oCols,sType)}return oCols}}();function Filter(props){for(var i in props){this[i]=props[i]}}Filter.prototype=function(){return{constructor:Filter,normalize:normalize};function normalize(oTab){try{if(this.type=="mask"){this.col=oTab.findCol(this.field);if(!this.col){this.title="?"+this.field}else{this.title=this.col.getTitle()}}if(this.init)oTab.props.oSel[this.name]=this.init;log("---- normalize "+oTab.props.recTitle+" "+this.type+" name="+this.name+" fld="+this.field+" col="+this.col+" title="+this.title+" init="+this.init)}catch(e){log("filter trap "+e,this)}return this}}();oApp.directive("autocomplete",function(){return{restrict:"A",require:"?ngModel",priority:500,link:function(scope,element,attrs,ngModel){log("keyup autocomplete linker");if(!ngModel)return;var sFlag=attrs.autocomplete;var sNext=attrs.next;element.bind("focus",function(){focus()});element.bind("keyup",function(oEvt){if(scope.sAutoName!=null){if(oEvt.keyCode==13){log("keyup auto="+scope.sAutoName+" next="+sNext+" flag="+sFlag);ngModel.$setViewValue(scope.sAutoName);element.val(scope.sAutoName);setFlag(false);if(sNext)scope.$eval(sNext);var oPrev=scope;var oPar=scope.$parent;while(oPar){oPrev=oPar;oPar=oPar.$parent}oPrev.$digest()}}});function focus(){ngModel.$setViewValue("");element.val("");scope.sAutoName=null;setFlag(true);log("focus autocomplete scope=%o flag=%s next=%s",scope,sFlag,sNext);scope.$digest()}function setFlag(b){if(!sFlag)return;var sParts=sFlag.split(".");if(sParts.length==1)scope[sParts[0]]=b;if(sParts.length==2)scope[sParts[0]][sParts[1]]=b}}}});oApp.directive("autotab",function(){return{restrict:"A",priority:500,link:function(scope,element,attrs,ngModel){var sNext=attrs.autotab;element.bind("keyup",function(oEvt){if(oEvt.keyCode==13){log("autotab event %o",oEvt);if(scope.sAutoName!=null){if(sNext)scope.$eval(sNext);scope.$digest()}}})}}});oApp.directive("scopeVar",function($parse){return{restrict:"A",link:function(scope,element,attrs,ngModel){var sExpr=attrs.scopeVar;var nIX=sExpr.indexOf("=");var sVar=sExpr.substring(0,nIX).trim();var sFunc=sExpr.substring(nIX+1).trim();log("scopeVar called var="+sVar+" func:"+sFunc);var oFunc=$parse(sFunc);scope.$watch(function(){if(scope[sVar]){return scope[sVar]}var oTab=oFunc(scope);return oTab},function(oNew,oOld){scope[sVar]=oNew})}}});oApp.directive("whenActive",function($rootScope){return function(scope,oE,oAttrs){var sFunc=oAttrs.whenActive;oE.bind("click",function(evt){var bActive=!oE.hasClass("c-quiet");log("whenActive click scope=%s %o %o func=%s active="+bActive,scope.$parent.$id,evt,oE,sFunc);if(!bActive)return;if(angular.isDefined(window.ga))ga("send","event","action","click",sFunc);$rootScope.oCurEvent=evt;scope.$apply(sFunc)})}});oApp.directive("focusClear",function($parse){return{restrict:"A",require:"?ngModel",link:function(scope,element,attrs,ngModel){if(!ngModel)return;var sFocus=attrs.focusClear;var oFunc=null;if(sFocus&&sFocus.length>0)oFunc=$parse(sFocus);element.bind("focus",function(){ngModel.$setViewValue(null);element[0].value="";if(oFunc)oFunc(scope)})}}});oApp.directive("blurEvent",function($parse){return{restrict:"A",link:function(scope,element,attrs,ngModel){var sBlur=attrs.blurEvent;var sNext=attrs.blurNext;var oFunc=$parse(sBlur);element.bind("blur",function(){oFunc(scope)});element.bind("keypress",function(oEvt){if(oEvt.charCode==13){oFunc(scope);if(sNext)scope.$eval(sNext)}})}}});oApp.directive("macro",["$compile","$templateCache","$timeout",function($compile,$templateCache,$timeout){var oCache={};return{restrict:"E",require:"?ngModel",replace:true,transclude:false,scope:false,compile:compiler};function compiler(oElem,oAttr){var sHint="";var i,iMax;return{pre:function($scope,oElem,oAttr,oCtrl){if(oAttr.optFetch)return;if(oAttr.optFetch01)return;if(oAttr.optFetch02)return;var sFetch=oAttr.fetch||null;var sCol=oAttr.col||null;var sAlter=oAttr.alter||null;var sMode=oAttr.mode||"List";var sMarker=oAttr.marker||"no-marker";var sObj=oAttr.obj||"oObj";var sObjRef=oAttr.objref||null;if(sObjRef)sObj=$scope.$eval(sObjRef);var oCol=null;var sField=null;if(sCol){oCol=$scope[oAttr.col];sField=oCol.getField()}var sHtml=null;if(sFetch){if(oGBL.templates){log("convert templates ",oGBL.templates);for(i=0,iMax=oGBL.templates.length;i<iMax;i+=1){var oTMP=oGBL.templates[i];var sBest=compileReady(oTMP.html);sBest="<!-- template "+oTMP.id+" $MARKER$ -->"+sBest;$templateCache.put(oTMP.id,sBest)}oGBL.$templateCache=$templateCache;oGBL.templates=null}sHtml=$templateCache.get(sFetch);if(!sHtml){sHtml="<!-- gen.0 $MARKER$ --><span class=warn>lost "+sFetch+" template</span>";log("fetch HTML "+sFetch+" not located")}}else{sHtml="<!-- gen.1 $MARKER$ --><span>{{"+sCol+".getValue(this,"+sObj+")}}</span>";if(sMode=="Edit")sHtml="<!-- gen.2 $MARKER$ --><input type=text name="+oCol.getID()+">";if(oCol["html"+sMode]){sHtml=$templateCache.get(oCol["html"+sMode]);if(sHtml==null)sHtml="<!-- gen.3 $MARKER$ --><span class=warn>lost "+oCol["html"+sMode]+" template</span>"}else{if(oCol.type=="action"){sHtml="";for(i=0;i<oCol.methods.length;i+=1){var oA=oCol.methods[i];if(i>0)sHtml+="&nbsp;&nbsp;";var nRow="null";if(oAttr.row)nRow=""+oAttr.row;var sFuncName=getFuncName(oCol.methods[i].method);$scope[sFuncName]=oCol.methods[i].method;sHtml+="<a class='c-action sz-90' when-active=\""+sFuncName+"(this,"+sObj+","+nRow+')">'+oA.name+"</a>"}sHtml="<!-- gen.4 $MARKER$ -->"+sHtml}}}if(sHtml==null){sHtml="<!-- gen.0 $MARKER$ --><span class=warn>no HTML data col="+sCol+" mode="+sMode+"</span>";log("no HTML col="+sCol+" fetch="+sFetch+" scope=%o col=%o",$scope,oCol)}if(!sFetch){if(sHtml.indexOf("$MODEL$")>0){var sModel=sObj+"['"+sField+"']";sHtml=sHtml.replace(/[$]MODEL[$]/g,sModel)}if(sHtml.indexOf("$MODOBJ$")>0){sHtml=sHtml.replace(/[$]MODOBJ[$]/g,sObj)}if(oCol.hint){if(typeof oCol.hint=="function"){sHint="";var nIX=sHtml.indexOf(">");sHint=" title='{{("+sCol+".hint)("+sObj+")}}'"}else{sHint=oCol.hint}sHtml=sHtml.replace(/(<[a-zA-Z][^ >]*)(.)/g,"$1 "+sHint+"$2")}}if(sHtml.indexOf("$MARKER$")>0){sHtml=sHtml.replace(/[$]MARKER[$]/g,sMarker)}if(sHtml.indexOf("<img-defer")>0){sHtml=sHtml.replace(/(<\/?)img-defer/gi,"$1img")}if(sAlter)sHtml=tri.applyAlters(sHtml,sAlter);var oLinkFn=null;oLinkFn=$compile(sHtml);var oNewElem=oLinkFn($scope);oElem.replaceWith(oNewElem);if($scope.grabFocus){var oResult=sHtml.match(/<!--\sgrab-focus=([^ ]+)/);if(oResult!=null){oElem.sGrabFocus=oResult[1]}}},post:function($scope,oElem,oAttr,oCtrl){if(oElem.sGrabFocus){$timeout(function(){$scope.grabFocus($scope,oElem,oElem.sGrabFocus)},0)}}}}function compileReady(sRawHtml){var sStr="";var sLines=sRawHtml.split(/\n/);if(sLines.length>1){sStr="";for(var i=0;i<sLines.length;i+=1){var sLine=sLines[i].trim();sStr+=sLine}}else{return sRawHtml}return sStr}}]);oApp.directive("colRows",function(){return{restrict:"A",require:"?ngModel",priority:500,link:function postLink(scope,oEl,attrs,ngModel){var sFld=attrs.colRows;log("postlink "+oEl.attr("colRows")+" rows="+sFld+" "+oEl.attr("class"));attrs.$observe("ngModel",function(value){log("colRows now "+value)})}}});oApp.directive("triState",function($timeout){return function(scope,oTri,attrs){$timeout(function(){var ngModel=attrs.ngModel;var sFld=attrs.triState;var oFil=scope.getFilter(sFld);var oOpts=scope.getRefColOpt(oFil);log("Build select options "+oTri.attr("id")+" DOMid="+oTri[0].id+" "+ngModel+" opts="+oOpts.length);var sStr="";if(!scope.oSel)scope.oSel={};if(!scope.oSel[oFil.field])scope.oSel[oFil.field]={};if(!scope.oSel[oFil.field].status)scope.oSel[oFil.field].status={open:false,mode:"INCL",list:[]};var oStat=scope.oSel[oFil.field].status;oStat.tri=oTri;sStr+="<option class='dummy green0' value=x>"+scope.getColTitle(oFil)+"</option>";var sClass="black";for(var i in oOpts){var oOpt=oOpts[i];sStr+="<option class="+sClass+" title='"+oOpt.title+"' value="+oOpt.value+">"+oOpt.name+"</option>"}sStr+="<option class=dummy value=x></option>";sStr+="<option class=dummy value=x></option>";sStr+="<option class=dummy value=x></option>";oTri.html(sStr);oTri.after("<button id=but-id-3 class='tri-but-tri'>&gt;</button>");var oButTri=oTri.next();oButTri.after("<button id=but-id-1 class='tri-but-grn hide'>=</button>");var oButGrn=oButTri.next();oButGrn.after("<button id=but-id-2 class='tri-but-red hide'>~</button>");var oButRed=oButGrn.next();log("Button "+oButTri.attr("id"));oButTri[0].onclick=function(){if(!oStat.open){oStat.open=true;oButTri.text("X");oButRed.removeClass("hide");oButGrn.removeClass("hide");oTri.attr("multiple","1");oTri[0].options[0].selected=false;fixOption0()}else{oStat.open=false;oButRed.addClass("hide");oButGrn.addClass("hide");oButTri.text(">");oTri.removeAttr("multiple");oStat.list=[];var sTitle="";for(var i in oTri[0].options){if(oTri[0].options[i].value){var oOpt=oTri[0].options[i];if(oOpt.triSelected){oStat.list.push(i);sTitle+=","+oOpt.text}}else{}}if(oStat.list.length>0){oTri[0].options[0].text=scope.getColTitle(oFil)+":"+oStat.mode;oTri[0].title=(oStat.mode=="INCL"?"Include:":"Exclude:")+sTitle.substring(1)}else{oTri[0].options[0].text=scope.getColTitle(oFil)+": idle";oTri[0].title="no selected values"}oTri[0].options[0].value=""+(new Date).getTime();oTri[0].options[0].selected=true;scope.$apply(ngModel)}log("clicked button for "+oTri[0].id+" "+oButTri.attr("class"))};oButRed[0].onclick=function(){oStat.mode="EXCL";fixOption0();fixOptionClasses()};oButGrn[0].onclick=function(){oStat.mode="INCL";fixOption0();fixOptionClasses()};function fixOption0(){oTri[0].options[0].text=scope.getColTitle(oFil)+":"+oStat.mode;var oAO=oTri.find("option").eq(0);oAO.removeClass("green0");oAO.removeClass("red0");oAO.addClass(oStat.mode=="INCL"?"green0":"red0")}function fixOptionClasses(){var nIX=-1;for(var i in oTri[0].options){if(oTri[0].options[i].value){nIX+=1;var oOpt=oTri[0].options[i];var oAO=oTri.find("option").eq(nIX);if(oOpt.triSelected){oAO.removeClass("red green black");oAO.addClass(oStat.mode=="INCL"?"green":"red")}else{if(nIX>0){oAO.removeClass("red green");oAO.addClass("black")}}}}}oTri[0].onchange=function(){var nIX=-1;for(var i in oTri[0].options){if(oTri[0].options[i].value){nIX+=1;var oOpt=oTri[0].options[i];var oAO=oTri.find("option").eq(nIX);if(oOpt.selected){oOpt.selected=false;if(oOpt.value!="x"&&nIX!==0){if(oOpt.triSelected){oOpt.triSelected=false}else{oOpt.triSelected=true}}}}}fixOptionClasses()}},1e3);var sFld=attrs.triState;log("connected tristate to "+sFld)}});oApp.factory("servREG",function(){log("Creating registry service");var oTabs=[];var oFuncs={};oFuncs.registerTable=function(tab){registerTab(tab)};oFuncs.getTables=function(){return oTabs};oFuncs.findTable=function(sTable){return findTable(sTable)};return oFuncs;function registerTab(tab){oTabs.push(tab);log("Registering table "+tab.getTabProp().recTitle+" Tables="+oTabs.length)}function findTable(sTable){for(var i=0,iMax=oTabs.length;i<iMax;i+=1){var oTD=oTabs[i];if(oTD.getTabProp().recTitle==sTable)return oTD}return null}});oApp.factory("servCRUD",["$rootScope","servREC","servGAE","servREG","servSess",function($rootScope,servREC,servGAE,servREG,servSess){var bInEdit=false;var nEditIX=0;var sEditType=null;var oCtrlEdit=null;var oDlgCtrlEdit=null;var oObjEdit=null;var oObjCopy=null;var oDlgEdit=null;var oFuncs={};oFuncs.hookCtrlEdit=function(ctrl){if(!oCtrlEdit)oCtrlEdit=ctrl;else oDlgCtrlEdit=ctrl};oFuncs.getCtrlEdit=function(bDlg){return bDlg?oDlgCtrlEdit:oCtrlEdit};oFuncs.inEdit=function(oTP){return inEdit()};oFuncs.inDlgEdit=function(){return oDlgEdit!=null&&inEdit()};oFuncs.setDlgEdit=function(nWid,nHgt){oDlgEdit=null;if(nWid&&nHgt)oDlgEdit={width:nWid,height:nHgt}};oFuncs.getAppStatKey=function(){return getAppStatKey()};oFuncs.getEditType=function(oTP){return getEditType};oFuncs.getObjEdit=function(){return oObjEdit};oFuncs.getEditIX=function(){return nEditIX};oFuncs.syncLocalData=function(scope,sToken,oData){syncLocalData(scope,sToken,oData)};oFuncs.refreshNonCachedTable=function(oT,oTbl,oTP){refreshNonCachedTable(oT,oTbl,oTP)};oFuncs.refreshTableCache=function(bPartial){refreshTableCache(bPartial)};oFuncs.getTabProp=function(){return servSess.getTabProp()};oFuncs.getObj=function(oTP,oaa){return getObj(oTP,oaa)};oFuncs.getObjs=function(oTP){return getObjs(oTP)};oFuncs.editRecord=function(oaa){editRecord(oaa)};oFuncs.makeRecord=function(){makeRecord()};oFuncs.dropRecord=function(oaa){dropRecord(oaa)};oFuncs.editCancel=function(){editCancel()};oFuncs.editSave=function(scope){editSave(scope)};oFuncs.dirtyMsg=function(scope){return dirtyMsg(scope)};oFuncs.dirtyClass=function(scope){return dirtyClass(scope)};servREC.setCRUD(oFuncs);servSess.setCRUD(oFuncs);return oFuncs;function syncLocalData(scope,sToken,oData){var bPartial=scope==null;var oStat=getAppStatus();oStat.token=sToken;oStat.user=servSess.getUser();oStat.user2=servSess.getUser2();log("syncLocalData tok=%s data=%o stat=%o",sToken,oData,oStat);if(!oData.DataStat){servGAE.setToken(null);servSess.setSession(false);servSess.setSect(null);servSess.setStatus(null);delete localStorage[".user-token"];if(scope!=null){scope.sErrMsg="Expected DataStat object";scope.$digest()}return}for(var i=0,iMax=oData.DataStat.RECORD.length;i<iMax;i+=1){var oRec=oData.DataStat.RECORD[i];matchTable(oStat,oRec)}log("registering stat=%o",oStat);servSess.setStatus(oStat);refreshLocalCache(bPartial)}function matchTable(oStat,oRec){var sParts=oRec.KeyName.split("/");for(var sVar in oStat.tables){var oTbl=oStat.tables[sVar];if(oTbl.recType==sParts[1]){if(oTbl.fileKey==sParts[2]){flagTable(oTbl,oRec,sParts[2])}else if(oTbl.fileKey[0]=="@"){var sFileKey=servSess.getProfile()[oTbl.fileKey.substring(1)];if(sFileKey==sParts[2]){flagTable(oTbl,oRec,sParts[2])}}else if(oTbl.type=="chunk"){var sMat=oTbl.fileKey.replace(/%/,"[0-9]+");if(new RegExp(sMat).test(sParts[2])){flagTable(oTbl,oRec,sParts[2])}}else if(oTbl.type=="table"){flagTable(oTbl,oRec,sParts[2])}else{log("table match failure rec=%o tbl=%o",oRec,oTbl)}}}}function flagTable(oTbl,oRec,sRecKey){if(!oTbl.map)oTbl.map={};oTbl.map[sRecKey]={UpdateTS:oRec.UpdateTS,GekID:oRec.GekID}}function getAppStatKey(){var sCust=servGAE.getCust();var sLocn=""+window.location;var oR=sLocn.match(/\/([a-zA-Z0-9]+)[.]htm/);var sApp=oR[1].toLowerCase();var sLSKey=".status-"+sCust+"-"+sApp;return[sLSKey,sCust,sApp]}function getAppStatus(){var sStrs=getAppStatKey();var sLSKey=sStrs[0];var sCust=sStrs[1];var sApp=sStrs[2];var oStat={key:sLSKey,cust:sCust,app:sApp,tables:{}};if(localStorage[sLSKey]){oStat=JSON.parse(localStorage[sLSKey])}var oTbls=servREG.getTables();for(var i=0,iMax=oTbls.length;i<iMax;i+=1){var oTbl=oTbls[i];var oTP=oTbl.getTabProp();var sName=oTP.recTitle;if(!oStat.tables[sName]){var sType="table";if(oTP.recServ.isCombined()){sType="record";if(oTP.recName.indexOf("%")>0)sType="chunk"}var sFileKey=oTP.recName;if(oTP.fileKeyRef)sFileKey="@"+oTP.fileKeyRef;var oT={name:sName,type:sType,recType:oTP.recType,recName:oTP.recName,fileKey:sFileKey,lsName:oTP.lsName};oStat.tables[sName]=oT}}localStorage[sLSKey]=JSON.stringify(oStat);return oStat}function refreshLocalCache(bPartial,bNewCache){var oStat=servSess.getStatus();log("refreshLocalData start sandbox=%s stat=%o",servSess.isSandboxMode(),oStat);for(var sV in oStat.tables){var oTbl=oStat.tables[sV];var oTab=servREG.findTable(oTbl.name);var oTP=oTab.getTabProp();oTP.statTbl=oTbl;oTP.oCRUD=oFuncs;if(!oTbl.lsName)continue;var sLSKey="."+oStat.app+oTbl.lsName+"-cache";var oCache=null;if(localStorage[sLSKey]){oCache=JSON.parse(localStorage[sLSKey])}else{oCache={key:sLSKey,map:{}};bNewCache=true}for(var sVar in oTbl.map){if(!(sVar in oCache.map)||oCache.map[sVar].UpdateTS!=oTbl.map[sVar].UpdateTS){log("refreshTable=%s tbl=%o cache=%o bPartial=%s sandbox=%s new=%s",sVar,oTbl,oCache,bPartial,servSess.isSandboxMode(),bNewCache);if(!bNewCache&&servSess.isSandboxMode()&&!oTP.recServ.isCombined())continue;servGAE.getKeyData(oTbl.recType,sVar,function(oObjs,oResult){log("goodRead tbl=%o cache=%o objs=%o result=%o var=%s",oTbl,oCache,{array:oObjs},oResult,sVar);if(oTbl.map[sVar].UpdateTS!=oResult.UpdateTS){log("Strange result tbl=%o cache=%o objs=%o result=%o",oTbl,oCache,{array:oObjs},oResult)}else{if(!oCache.map[sVar])oCache.map[sVar]={};oCache.map[sVar].UpdateTS=oTbl.map[sVar].UpdateTS;oCache.map[sVar].GekID=oTbl.map[sVar].GekID;oCache.map[sVar].KeyName=oResult.RECORD.KeyName;if(oTP.cacheLoadExit)oObjs=oTP.cacheLoadExit(sVar,oObjs);oCache.map[sVar].oObjs=oObjs;localStorage[sLSKey]=JSON.stringify(oCache);refreshLocalCache(bPartial,bNewCache)}},function(status,data){log("failRead tbl=%o cache=%o status=%o data=%o",oTbl,oCache,status,data)});return}}}log("refreshLocalData completed partial=%s sandbox=%s",bPartial,servSess.isSandboxMode());refreshTableCache(bPartial)}function refreshTableCache(bPartial){var oStat=servSess.getStatus();var oObjs,sKeys,i,iMax,sKey,oObj;for(var sV in oStat.tables){var oT=oStat.tables[sV];if(!oT.map&&oT.lsName)continue;var oTbl=servREG.findTable(oT.name);var oTP=oTbl.getTabProp();var sName=oTP.recTitle;var sLSKey="."+oStat.app+oT.lsName+"-cache";if(oT.type=="chunk"){oTP.oChunks=[];oTP.nNextChunk=0}if(oT.type=="table"||oT.type=="record"){oTP.oObjs=[]}if(!oT.lsName){refreshNonCachedTable(oT,oTbl,oTP)}else if(localStorage[sLSKey]){var oCache=JSON.parse(localStorage[sLSKey]);sKeys=Object.keys(oT.map);sKeys.sort();log("refresh table lsKey=%s oT=%o oTbl=%o oTP=%o cache=%o keys=%o partial=%s",sLSKey,oT,oTbl,oTP,oCache,{array:sKeys},bPartial);for(i=0,iMax=sKeys.length;i<iMax;i+=1){sKey=sKeys[i];if(oT.type=="record"){oObjs=oCache.map[sKey].oObjs;oTP.recServ.setObjs(oTP,oObjs);log("refresh Table=%s type=%s count=",sKey,oT.name,oT.type,oObjs.length)}else if(oT.type=="chunk"){oObjs=oCache.map[sKey].oObjs;oTP.oChunks.push({ls:sKey,oObjs:[]});oTP.recServ.addChunk(oTP,oObjs,oTP.nNextChunk);oTP.nNextChunk+=1}else if(oT.type=="table"){if(oCache.map[sKey]){oObj=angular.copy(oCache.map[sKey].oObjs);oObj.KeyName=oCache.map[sKey].KeyName;oObj.GekID=oCache.map[sKey].GekID;oTP.oObjs.push(oObj)}}else{log("Strange table type "+oT.type+" "+oT.name)}}if(oT.type=="table"){sKeys=Object.keys(oCache.map);var bDropped=false;for(i=0,iMax=sKeys.length;i<iMax;i+=1){sKey=sKeys[i];if(!oT.map[sKey]){if(servSess.isSandboxMode()){log("sandboxMode kept in cache "+sKey);oObj=angular.copy(oCache.map[sKey].oObjs);oTP.oObjs.push(oObj)}else{log("drop from cache "+sKey);delete oCache.map[sKey];bDropped=true}}}if(bDropped){log("reduced cache saved "+sLSKey);localStorage[sLSKey]=JSON.stringify(oCache)}}if(bPartial){servREC.refreshSignal("rsR",oTP);setTimeout(function(){$rootScope.$digest()},0)}}}}function refreshNonCachedTable(oT,oTbl,oTP){oTP.oObjs=[];log("refresh User table oT=%o oTbl=%o oTP=%o",oT,oTbl,oTP);var oUserTP=oTP;servGAE.issueFindFile(oUserTP.recType,oUserTP.recName,function(status,data){processGoodFind(oUserTP,status,data)},function(status,data){log("find failed stat=%o data=%o",status,data)})}function processGoodFind(oTP,status,data){var oObjs=[];for(var sVar in data.RESULT.RECORD){var oRec=angular.copy(data.RESULT.RECORD[sVar]);if(oRec.DataFld){oRec.obj=JSON.parse(oRec.DataFld);delete oRec.DataFld;oObjs.push(oRec)}}servREC.setObjs(oTP,oObjs);log("processed good find stat=%o data=%o objs=%o oTP=%o",status,data,{array:oObjs},oTP)}function dirtyMsg(){var oTP=servSess.getTabProp();if(oTP==null)return"?";if(canSave(oTP,oDlgEdit?oDlgCtrlEdit:oCtrlEdit))return"Save Changes";return"Make Changes"}function dirtyClass(){var oTP=servSess.getTabProp();if(oTP==null)return"c-quiet";if(canSave(oTP,oDlgEdit?oDlgCtrlEdit:oCtrlEdit))return"c-action";return"c-quiet"}function inEdit(){return bInEdit}function getEditType(){return sEditType}function editRecord(oaa){var oTP=servSess.getTabProp();if(oTP==null)return;log("editRecord TP=%o oaa=%s",oTP,oaa);bInEdit=true;nEditIX=oaa;sEditType="Edit";if(oTP.getEditRecordExit){oObjEdit=oTP.getEditRecordExit(oaa)}else{oObjEdit=angular.copy(getObj(oTP,oaa))}invokeEditor(oTP)}function makeRecord(){var oTP=servSess.getTabProp();if(oTP==null)return;bInEdit=true;nEditIX=null;sEditType="Create";oObjEdit={tag:getNextTag(oTP)};if(oTP.createExit){if(!oTP.createExit(oObjEdit)){editCancel(oTP);return}}invokeEditor(oTP)}function invokeEditor(oTP){if(oTP.primeEdit)oObjEdit=oTP.primeEdit(oDlgEdit?oDlgCtrlEdit:oCtrlEdit,oTP,oObjEdit);oObjCopy=angular.copy(oObjEdit);var oCE=null;if(oDlgEdit!=null){var sTitle="dlgRenderExit not defined";oDlgEdit.oTP=oTP;oDlgEdit.oDlg=$("#dlg-editor");oDlgEdit.finals=[];oDlgEdit.cansave=false;oDlgEdit.oDlg.dialog({autoOpen:false,modal:true,dialogClass:"ui-editor",title:"EDIT: "+sTitle,width:oDlgEdit.width,height:oDlgEdit.width,resizable:false,buttons:[{text:"Save",click:dlgSaveRecord,id:"but-save",disabled:true},{text:"Cancel Edit",click:dlgEditCancel,id:"but-cancel"}]});oDlgEdit.oDlg.dialog("open");oDlgEdit.oBut=$(".ui-dialog #but-save");if(oTP.dlgRenderExit)oTP.dlgRenderExit(oDlgEdit,oObjEdit,sEditType);oCE=oDlgCtrlEdit}else{oCE=oCtrlEdit}if(oCE){oCE.oObj=oObjEdit;oCE.sEditErr=null}}function dlgCanSave(bCanSave){if(!oDlgEdit)return bCanSave;if(!oDlgEdit.oBut)return bCanSave;if(oDlgEdit.cansave==bCanSave)return bCanSave;oDlgEdit.cansave=bCanSave;if(bCanSave){oDlgEdit.oBut.button("enable")}else{oDlgEdit.oBut.button("disable")}return bCanSave}function dlgSaveRecord(what){if(!oDlgEdit)return;log("Dialog save record %o %s",what,oDlgEdit.cansave);if(!oDlgEdit.cansave)return;oDlgEdit.oTP.recServ.insertRec(oDlgEdit.oTP,oObjEdit,nEditIX);bInEdit=false;nEditIX=null;sEditType=null;oObjEdit=null;oObjCopy=null;if(oDlgCtrlEdit){oDlgCtrlEdit.oObj=null;oDlgCtrlEdit.sEditErr=null}dlgCleanup();$rootScope.$digest()}function dlgCleanup(){for(var i=0,iMax=oDlgEdit.finals.length;i<iMax;i+=1){oDlgEdit.finals[i]()}oDlgEdit.oDlg.dialog("close");oDlgEdit.oDlg=null}function dlgEditCancel(what){log("Dialog edit cancel %o",what);editCancel();if(!bInEdit){dlgCleanup()
}}function getNextTag(oTP){var oRecs=getObjs(oTP);var nTag=0;for(var sVar in oRecs){var oRec=oRecs[sVar];var tag=+oRec.tag;if(tag>nTag)nTag=tag}return nTag+1}function editCancel(oTP){oTP=servSess.getTabProp();if(oTP==null)return;if(isDirty()){if(!confirm("Press OK if you are willing to lose changes to "+oTP.recName+" record"))return}bInEdit=false;nEditIX=null;sEditType=null;oObjEdit=null;oObjCopy=null;var oCE=oDlgEdit?oDlgCtrlEdit:oCtrlEdit;if(oCE){oCE.oObj=null;oCE.sEditErr=null}}function editSave(scope){var oTP=servSess.getTabProp();if(oTP==null)return;log("editSave scope=%o, TP=%o, oObjEdit=%o",scope,oTP,oObjEdit);if(!canSave(oTP,scope))return;oTP.recServ.insertRec(oTP,oObjEdit,nEditIX);bInEdit=false;nEditIX=null;sEditType=null;oObjEdit=null;oObjCopy=null;var oCE=oDlgEdit?oDlgCtrlEdit:oCtrlEdit;if(oCE){oCE.oObj=null;oCE.sEditErr=null}}function dropRecord(oaa){log("Drop record "+oaa);if(!confirm("Press OK if you wish to remove record from the system.\r\nThis action is not reversible."))return;var oTP=servSess.getTabProp();if(oTP==null)return;var oT=oTP.statTbl;var oObj=getObj(oTP,oaa);if(!oObj)return;log("Drop record oaa=%s oTP=%o tbl=%o obj=%o",oaa,oTP,oT,oObj);if(oT.type=="table"){dropTableRecord(oT,oTP,oObj,oaa)}else{dropRecordRecord(oTP,oObj,oaa)}}function dropRecordRecord(oTP,oObj,oaa){var oNew;if(oTP.oChunks){var nChunk=oTP.oChunks.length-1;var oRecs=null;var sParts=oaa.split(".");nChunk=+sParts[0];var oChunk=oTP.oChunks[nChunk];oNew=removeObj(oTP.oChunks[nChunk].oObjs,oObj,nChunk);oTP.oChunks[nChunk].oObjs=oNew;oTP.recServ.saveRecords(oTP,oNew,oChunk.ls,oTP.lsName,true)}else{oNew=removeObj(oTP.oObjs,oObj,null);oTP.oObjs=oNew;var sFileKey=oTP.recName;if(oTP.fileKey)sFileKey=oTP.fileKey();oTP.recServ.saveRecords(oTP,oNew,sFileKey,oTP.lsName,true)}log("dropped oaa="+oaa+" from "+oTP.recName)}function dropTableRecord(oT,oTP,oObj,oaa){if(servSess.isSandboxMode()){servSess.setConfirmMsg("Record dropped in sandbox");var sParts=oTP.oCRUD.getAppStatKey();var sCache="."+sParts[2]+oTP.lsName+"-cache";var oCache=null;if(localStorage[sCache])oCache=JSON.parse(localStorage[sCache]);log("sandbox drop oTP=%o obj=%o oaa=%s cache=%o",oTP,oObj,oaa,oCache);if(oCache){delete oCache.map[oObj.name];localStorage[sCache]=angular.toJson(oCache);log("cacheUpdated cache=%o oTP.cache=%o obj=%o",oCache,{objs:oTP.oCache},oObj);delete oTP.oCache;oTP.oCRUD.refreshTableCache(true);oTP.oCRUD.getObjs(oTP);oTP.oPrevSel=null;oTP.cycle=""+(new Date).getMilliseconds()}}else{servGAE.dropObj(oObj,goodDrop,failedDrop)}function goodDrop(status,data){servSess.setConfirmMsg("Record drop successful");if(oT.lsName==null){var oTbl=servREG.findTable(oT.name);refreshNonCachedTable(oT,oTbl,oTP)}else{servGAE.issueFindFile(oTP.recType,"%",function(status,data){log("drop/find good stat=%o data=%o",status,data);var oData={DataStat:{RECORD:data.RESULT.RECORD}};oTP.oCRUD.syncLocalData(null,servGAE.getToken(),oData)},function(status,data){log("find failed stat=%o data=%o",status,data)})}return}function failedDrop(status,data){servSess.setErrorMsg("Record drop failed:"+data["status-message"]);return}}function isDirty(){if(!oObjEdit)return false;if(!oObjCopy)return false;return!angular.equals(oObjEdit,oObjCopy)}function canSave(oTP,scope){if(!validate(oTP,scope))return dlgCanSave(false);if(!isDirty())return dlgCanSave(false);return dlgCanSave(true)}function validate(oTP,scope){oCtrlEdit.sEditErr=null;if(oDlgCtrlEdit)oDlgCtrlEdit.sEditErr=null;if(!oObjEdit)return true;if(!oTP)return true;if(oTP.validate)return oTP.validate(scope,oObjEdit,oObjCopy,validateStd,editError);return validateStd(oTP)}function validateStd(oTP){for(var sVar in oTP.cols){var oCol=oTP.cols[sVar];if(typeof oCol.col=="function")continue;if(oCol.type=="list")continue;if(oCol.type=="actions")continue;if(oCol.type=="action")continue;var bData=true;if(!(oCol.col in oObjEdit)||oObjEdit[oCol.col]==null||oObjEdit[oCol.col].length===0)bData=false;if(!("reqd"in oCol)||oCol.reqd){if(!(oCol.col in oObjEdit)||oObjEdit[oCol.col]==null)return editError("Field '"+oCol.col+"' required");var nMin=0;if(angular.isNumber(oCol.reqd))nMin=oCol.reqd;if(oObjEdit[oCol.col].length<=nMin)return editError("Required field '"+oCol.col+"' blank or too short")}if("many"in oCol&&!oCol.many){if(bData){if(isDuplicate(oTP,oObjEdit,oCol))return editError("Duplicate value for field '"+oCol.col+"'")}}if("mask"in oCol&&bData){var oMask=new RegExp(oCol.mask);if(oObjEdit[oCol.col].match(oMask)==null)return editError("Wrong data format in field '"+oCol.col+"'")}if("type"in oCol&&oCol.type=="property"){var bOK=true;angular.forEach(oObjEdit[oCol.col],function(value,key){if(value==null||value.trim().length===0){bOK=editError("Property '"+key+"' has no value")}});if(!bOK)return false}}return true}function isDuplicate(oTP,oRec,oCol){var sCol=oCol.col;if(!(sCol in oRec))return false;var oRecs=getObjs(oTP);var sFld=""+oRec[sCol];if(!("case"in oCol)||oCol.case){sFld=sFld.toUpperCase()}for(var sVar in oRecs){var oObj=oRecs[sVar];if(oRec.oaa==oObj.oaa)continue;var sStr=oObj[sCol];if(sStr===undefined||sStr===null)sStr="";if(!("trim"in oCol)||oCol.trim)sStr=sStr.trim();if(!("case"in oCol)||oCol.case)sStr=sStr.toUpperCase();if(sStr===sFld)return true}return false}function editError(sErrMsg){oCtrlEdit.sEditErr=sErrMsg;if(oDlgCtrlEdit)oDlgCtrlEdit.sEditErr=sErrMsg;return false}function getObj(oTP,oaa){if(!oTP)oTP=servSess.getTabProp();if(!oTP)return null;if(typeof oaa=="string"){var sParts=oaa.split(".");return oTP.oChunks[sParts[0]].oObjs[sParts[1]]}else{return oTP.oObjs[oaa]}}function getObjs(oTP){var sVar,oRec;if(!oTP)oTP=servSess.getTabProp();if(!oTP)return[];if(oTP.oCache)return oTP.oCache;oTP.oCache=[];if(oTP.oChunks){log("getChunks "+oTP.oChunks.length+" "+oTP.recTitle);for(var i in oTP.oChunks){var oChunk=oTP.oChunks[i];for(sVar in oChunk.oObjs){if(typeof sVar=="string"&&sVar.charAt(0)=="$")continue;oRec=oChunk.oObjs[sVar];oRec.oaa=""+i+"."+sVar;oTP.oCache.push(oRec)}}}else{for(sVar in oTP.oObjs){if(typeof sVar=="string"&&sVar.charAt(0)=="$")continue;oRec=oTP.oObjs[sVar];oRec.oaa=+sVar;oTP.oCache.push(oRec)}}if(oTP.order){var xCol=null;var bReverse=false;if(angular.isString(oTP.order)){xCol=oTP.order}else if(angular.isFunction(oTP.order)){xCol=oTP.order}else{xCol=oTP.order.col;bReverse="reverse"==oTP.order.seq;log("using reverse sort "+xCol+" "+oTP.order.seq+" "+typeof oTP.order)}var oCol=findCol(oTP,xCol);if(oCol){var s1=null;var s2=null;oTP.oCache.sort(function(a,b){if(typeof oCol.col=="function"){s1=oCol.col(a).toUpperCase();s2=oCol.col(b).toUpperCase()}else{s1=(""+a[oCol.col]).toUpperCase();s2=(""+b[oCol.col]).toUpperCase()}if(bReverse){if(s1<s2)return 1;if(s1==s2)return 0;return-1}else{if(s1<s2)return-1;if(s1==s2)return 0;return 1}})}else{log("Sort col %s not found %o",xCol,oTP)}}return oTP.oCache}function findCol(oTP,sCol){for(var i in oTP.cols){var oCol=oTP.cols[i];if(oCol.col===sCol)return oCol}return null}}]);oApp.factory("servSess",["servREC","servGAE","servREG","servConfig",function(servREC,servGAE,servREG,servConfig){var bSession=false;var bDevpMode=false;var sTitle="to be defined";var sErrorMsg=null;var sConfirmMsg=null;var sToken=null;var oPrtChq=null;var oLogonExit=null;var oBootExit=null;var oProf=null;var sDouble=null;var sUser=null;var sUser2=null;var sSect=null;var oTAB=null;var oOptMenuItems=[];var nIdleSecs=0;var nIdleMax=65;var oIdleListener=null;var oListListener=null;var nClear=null;var oStatus=null;var oCRUD=null;var oFuncs={};oFuncs.setCRUD=function(crud){oCRUD=crud};oFuncs.hasSession=function(){return bSession};oFuncs.canChangePassword=function(){return canChangePassword()};oFuncs.setSession=function(bSess,oP){setSession(bSess,oP)};oFuncs.getErrorMsg=function(){return sErrorMsg};oFuncs.setErrorMsg=function(msg){sErrorMsg=msg};oFuncs.setLogonExit=function(logonexit){oLogonExit=logonexit};oFuncs.setBootExit=function(bootexit){oBootExit=bootexit};oFuncs.getBootExit=function(){return oBootExit};oFuncs.getListCtrl=function(){return oListListener};oFuncs.getConfirmMsg=function(){return sConfirmMsg};oFuncs.setConfirmMsg=function(msg){sConfirmMsg=msg};oFuncs.getProfile=function(){return oProf};oFuncs.setUser=function(sDbl,user,user2){sDouble=sDbl;sUser=user;sUser2=user2};oFuncs.getUser=function(){return sUser};oFuncs.getUser2=function(){return sUser2};oFuncs.isDouble=function(){return sDouble=="DOUBLE"};oFuncs.isSandboxMode=function(){return isSandboxMode()};oFuncs.isAdmin=function(){return isAdmin()};oFuncs.isRole=function(sRole){return isRole(sRole)};oFuncs.isPrtApp=function(){return bPrtApp};oFuncs.getToken=function(){return sToken};oFuncs.setToken=function(tok){sToken=tok};oFuncs.getSect=function(){return sSect};oFuncs.getTabServ=function(){return oTAB};oFuncs.setSect=function(sect,tabdef){setSect(sect,tabdef)};oFuncs.isSect=function(sect){return sSect==sect};oFuncs.setOptMenuItems=function(list){oOptMenuItems=list};oFuncs.getOptMenuItems=function(){return getOptMenuItems()};oFuncs.getTitle=function(){return getTitle()};oFuncs.getSandboxMsg=function(){return getSandboxMsg()};oFuncs.setTitle=function(title){sTitle=title};oFuncs.setDevpMode=function(){bDevpMode=true};oFuncs.setStatus=function(stat){oStatus=stat};oFuncs.getStatus=function(){return oStatus};oFuncs.xfrAdminApp=function(sApp,sTbls){xfrAdminApp(sApp,sTbls)};oFuncs.createFormWindow=function(pref,hand,page,form){createFormWindow(pref,hand,page,form)};oFuncs.maskReduce=function(oObjs,sMask,sFld){return maskReduce(oObjs,sMask,sFld)};oFuncs.getTabProp=function(){return getTabProp()};oFuncs.useTable=function(scope,table,sel){return useTable(scope,table,sel)};oFuncs.getIdleSecs=function(){return nIdleSecs};oFuncs.getIdleLeft=function(){return getIdleLeft()};oFuncs.hookIdleListener=function(ctrl){oIdleListener=ctrl};oFuncs.hookListListener=function(ctrl){oListListener=ctrl};oFuncs.hookMenuListener=function(ctrl){oMenuListener=ctrl};return oFuncs;function setSession(bSess,oP){bSession=bSess;oProf=oP;if(oP)log("setSession Profile",oProf);if(bSess){if(getAutoLogSecs()>0){initTimeOutManager();nIdleMax=getAutoLogSecs()}else{log("AutoLogoff disabled for "+sUser)}}else{if(nClear!=null){window.clearInterval(nClear);nClear=null}}if(oLogonExit)oLogonExit(oProf)}function initTimeOutManager(){document.onclick=function(){haveActivity()};document.onmousemove=function(){haveActivity()};document.onkeypress=function(){haveActivity()};nClear=window.setInterval(checkIdleTime,1e3);function haveActivity(){if(bSession&&nIdleSecs>120){nIdleSecs=0;revalidateToken()}nIdleSecs=0}}function revalidateToken(){var sToken=null;if(localStorage[".user-token"])sToken=localStorage[".user-token"];if(sToken==null)return;servGAE.validateToken(sUser,sToken,good,fail);function good(status,data){log("revalidate succeeded")}function fail(status,data){log("revalidate failed");if(oIdleListener)oIdleListener.autoLogoff()}}function checkIdleTime(){nIdleSecs+=1;if(oIdleListener){if(nIdleMax&&nIdleSecs>nIdleMax)oIdleListener.autoLogoff();if(nIdleMax&&nIdleSecs>nIdleMax-60)oIdleListener.pulse();if(nIdleSecs==1)oIdleListener.pulse()}}function canChangePassword(){if(isSandboxMode())return false;if(!bSession)return false;if(sUser2!=sUser&&sUser2)return false;return true}function getIdleLeft(){if(nIdleMax&&nIdleSecs>nIdleMax)return 0;if(nIdleMax&&nIdleSecs>=nIdleMax-60){var nRet=nIdleMax-nIdleSecs;if(nRet==59||nRet==20){var oAudio=document.getElementById("audio-alert");if(oAudio)oAudio.play()}return nRet}return null}function xfrAdminApp(sApp,sTbls){if(oCRUD.inEdit())return;var sURL=""+window.location;var nIX=sURL.indexOf("/apps");localStorage._admin_app_return=sURL.substring(nIX);var sNewURL=sURL.substring(0,nIX)+"/apps/tri/Admin.htm?cust="+sApp;if(sTbls){var sSep="&tables=";for(var i=0,iMax=sTbls.length;i<iMax;i+=1){sNewURL+=sSep+sTbls[i];sSep=";"}}log("XAF "+sURL+" new="+sNewURL);window.location=sNewURL}function createFormWindow(sPref,oHandler,sPage,sForm){oGBL.msgHandler[sPref]=oHandler;var sLocn=""+window.location;sLocn=sLocn.replace(sPage,sForm);sLocn=sLocn.replace(/#/,"");var sFormID=sForm;var nIX=sForm.indexOf(".");if(nIX>0)sFormID=sForm.substring(0,nIX);log("locn="+sLocn+" form="+sFormID);window.open(sLocn,sFormID+"-NewTab")}function getTitle(){var sStr=sTitle||"no-app-title";var sSite=null;if(servConfig.getSite)sSite=servConfig.getSite();if(sSite)sStr=sSite+" - "+sStr;if(bDevpMode)sStr="d:"+sStr;document.title=sStr;return sStr}function getSandboxMsg(){if(isSandboxMode())return"***Sandbox mode: no updates applied to server***";return""}function getOptMenuItems(){var oList=[];for(var i=0,max=oOptMenuItems.length;i<max;i+=1){var oMenu=oOptMenuItems[i];if(!oMenu.role){oList.push(oMenu)}else{var sRole="";if(oProf&&oProf.role)sRole=oProf.role;if(sRole.indexOf(oMenu.role)>=0){oList.push(oMenu)}else{if(oMenu.sandbox&&isSandboxMode())oList.push(oMenu)}}}return oList}function useTable(scope,sTable,sel){if(sTable){var oTabs=servREG.getTables();for(var i=0,iMax=oTabs.length;i<iMax;i+=1){var oTD=oTabs[i];if(oTD.getTabProp().recTitle==sTable){var oTab=new Table(oTD,scope,oCRUD);if(oTab.props.oSel&&sel){scope[sel]=oTab.props.oSel;log("use defined Table sel="+sel+" scope="+scope.$id,scope[sel])}return oTab}}return null}if(oTAB==null)return null;oTAB.scope=scope;if(oTAB.props.oSel){scope.oSel=oTAB.props.oSel}if(oTAB.props.primeList){oTAB.props.primeList(oTAB.scope,oTAB.props)}log("use current Table %s oTP=%o oSel=%o scope=%s",oTAB.props.recTitle,oTAB.props,scope.oSel,scope.$id);return oTAB}function getTabProp(){if(!oTAB)return null;var oTP=oTAB.props;return oTP}function setSect(sect,tabdef){if(oCRUD.inEdit())return;sSect=sect;if(tabdef){oTAB=new Table(tabdef,null,oCRUD)}else{oTAB=null}if(oTAB!=null){log("setSection sect=%s tab=%s props=%o",sect,oTAB.props.recTitle,oTAB.props)}if(oListListener)oListListener.oTAB=null;var oCtrlEdit=oCRUD.getCtrlEdit(true);if(oCtrlEdit){oCtrlEdit.oTAB=null;log("editScope oTAB nulled "+oCtrlEdit.$id)}}function isAdmin(){return isRole("admin")}function isRole(sRole){if(oProf==null)return false;if(!oProf.role)return false;if(oProf.role.indexOf(sRole)>=0)return true;return false}function isSandboxMode(){if(oProf==null)return false;if(!oProf.sandbox)return false;if(oProf.sandbox=="true")return true;return false}function getAutoLogSecs(){if(oProf==null)return 300;if(!oProf.autolog)return 300;return+oProf.autolog}function maskReduce(oObjs,sMask,sFld){if(sMask.trim()==="")return oObjs;var oNew=[];var oMask=new RegExp(sMask,"i");for(var i=0,iMax=oObjs.length;i<iMax;i+=1){var oObj=oObjs[i];if(oObj[sFld]&&(""+oObj[sFld]).match(oMask)!=null){oNew.push(oObj)}}return oNew}}]);oApp.factory("servGAE",["$http","servREG",function($http,servREG){var sURL=null;var sCust=null;var sUser=null;var sToken=null;var nAjaxID=100;var oFuncs={};oFuncs.setURL=function(url){sURL=url;log("AjaxURL:"+sURL)};oFuncs.getURL=function(){return sURL};oFuncs.setCust=function(cust){sCust=cust};oFuncs.getCust=function(){return sCust};oFuncs.setToken=function(token){sToken=token;localStorage[".user-token"]=token};oFuncs.getToken=function(){return sToken};oFuncs.login=function(xUser,sPW,fOK,fFail){login(xUser,sPW,fOK,fFail)};oFuncs.validateToken=function(user,token,fOK,fFail){validateToken(user,token,fOK,fFail)};oFuncs.getKeyData=function(sType,sKey,fOK,fFail){getKeyData(sType,sKey,fOK,fFail)};oFuncs.putKeyData=function(sType,sKey,sStr,fOK,fFail){putKeyData(sType,sKey,sStr,fOK,fFail)};oFuncs.issueFindFile=function(sRecType,sRecKey,fOK,fFail){issueFindFile(sRecType,sRecKey,fOK,fFail)};oFuncs.changePassword=function(sOld,sNew,fOK,fFail){changePassword(sOld,sNew,fOK,fFail)};oFuncs.sendReminder=function(sUser,fOK,fFail){sendReminder(sUser,fOK,fFail)};oFuncs.dropObj=function(oObj,fOK,fFail){dropObj(oObj,fOK,fFail)};oFuncs.validateStore=function(fOK,fFail){validateStore(fOK,fFail)};oFuncs.primeStore=function(sUser,sPW,fOK,fFail){primeStore(sUser,sPW,fOK,fFail)};oFuncs.superLogin=function(sUser,sPW,fOK,fFail){superLogin(sUser,sPW,fOK,fFail)};oFuncs.addAdminUser=function(oNew,sUser,sPW,fOK,fFail){addAdminUser(oNew,sUser,sPW,fOK,fFail)};oFuncs.listApps=function(sUser,sPW,fOK,fFail){listApps(sUser,sPW,fOK,fFail)};return oFuncs;function validateToken(user,token,fOK,fFail){sUser=user;sToken=token;var oJO=formatGemsReq("ValidateToken");log("ValidateToken %o",oJO);issueAjaxRequest(oJO,fOK,fFail)}function validateStore(fOK,fFail){var oJO=formatGemsReq("ValidateStore");log("ValidateStore %o",oJO);issueAjaxRequest(oJO,fOK,fFail)}function primeStore(sUser,sPW,fOK,fFail){var oJO=formatGemsReq("PrimeStore");log("PrimeStore %o",oJO);oJO.EXEC.auth.user=sUser;oJO.EXEC.auth.password=sPW;log("PrimeStore %o",oJO);issueAjaxRequest(oJO,fOK,fFail)}function superLogin(sUser,sPW,fOK,fFail){var oJO=formatGemsReq("SuperLogin");oJO.EXEC.auth.user=sUser;oJO.EXEC.auth.password=sPW;log("SuperLogin %o",oJO);issueAjaxRequest(oJO,fOK,fFail)}function addAdminUser(oNew,sUser,sPW,fOK,fFail){var oJO=formatGemsReq("AddAdminUser");oJO.EXEC.auth.cust=sCust;oJO.EXEC.auth.user=sUser;oJO.EXEC.auth.password=sPW;oJO.EXEC.payload=oNew;log("AddAdminUser %o",oJO);issueAjaxRequest(oJO,fOK,fFail)}function listApps(sUser,sPW,fOK,fFail){var oJO=formatGemsReq("ListApps");oJO.EXEC.auth.user=sUser;oJO.EXEC.auth.password=sPW;log("ListApps %o",oJO);issueAjaxRequest(oJO,fOK,fFail)}function login(xUser,sPW,fOK,fFail){sUser=xUser;var sUser2=null;if(angular.isObject(xUser)){sUser=xUser.user1;sPW=xUser.password1}log("trying HTTP request user="+sUser+" cust="+sCust+" type="+typeof xUser);localStorage[".user"]=sUser;localStorage[".user2"]=null;var oJO=formatGemsReq("Login",sPW);if(angular.isObject(xUser)){sUser2=xUser.user2;oJO.EXEC.auth.user2=xUser.user2;oJO.EXEC.auth.password2=xUser.password2;localStorage[".user2"]=xUser.user2}log("login request %o",oJO);issueAjaxRequest(oJO,fOK,fFail)}function getKeyData(sType,sKey,fOK,fFail){var oJO=formatGemsReq("ReadCitaData",sType,sKey);issueAjaxRead(oJO,fOK,fFail)}function dropObj(oObj,fOK,fFail){var oJO=formatGemsReq("DeleteKey",null,oObj.KeyName);oJO.EXEC.payload.GekID=oObj.GekID;issueAjaxRequest(oJO,fOK,fFail);log("dropObj %o",oJO)}function putKeyData(sType,sKey,sStr,fOK,fFail){var oJO=formatGemsReq("SendCitaData",sType,sKey,sStr);issueAjaxRequest(oJO,fOK,fFail)}function changePassword(sOld,sNew,fOK,fFail){var oJO=formatGemsReq("ChangePassword",sOld,sNew);issueAjaxRequest(oJO,fOK,fFail);log("changePassword %o",oJO)}function sendReminder(sUser,sNew,fOK,fFail){var oJO=formatGemsReq("SendReminder",sUser);issueAjaxRequest(oJO,fOK,fFail);log("sendReminder %o",oJO)}function issueAjaxRequest(oJO,fSuccess,fError){log("AJAX.AJAX.AJAX. issue ajax request %s %o url=%s",oJO.EXEC.ajaxMeth,oJO,sURL);$http({method:"POST",url:sURL,data:"json="+escape_utf8(JSON.stringify(oJO)),headers:{"Content-Type":"Application/x-www-form-urlencoded;charset=UTF-8"}}).success(function(data,status){if(data.status!="GOOD"){fError(status,data)}else{fSuccess(status,data)}}).error(function(data,status){fError(status,data)})}function issueAjaxRead(oJO,fSuccess,fError){log("AJAX.AJAX.AJAX. issue ajax read request %o",oJO);$http({method:"POST",url:sURL,data:"json="+escape_utf8(JSON.stringify(oJO)),headers:{"Content-Type":"Application/x-www-form-urlencoded;charset=UTF-8"}}).success(function(data,status){if(data.status!="GOOD"){fError(status,data)}else{log("Check read %o",data);if(!data.RESULT.RECORD.DataFld){log("missing data %o",data);fSuccess([])}else{var sText=data.RESULT.RECORD.DataFld;sText=sText.replace(/\r/,"");sText=sText.replace(/\n/,"");var oObjs=JSON.parse(sText);fSuccess(oObjs,data.RESULT)}}}).error(function(data,status){fError(status,data)})}function issueFindFile(sRecType,sRecKey,fOK,fFail){var oJO=null;if(sRecType){oJO=formatGemsReq("FindCitaData",sRecType,sRecKey)}else{oJO=formatGemsReq("FindUserData",sRecType,sRecKey)}log("Find....Data",oJO);issueAjaxRequest(oJO,fOK,fFail)}function formatGemsReq(sMeth,sRecType,sRecKey,sDataFld){log("formatGemsReq user="+sUser+" meth="+sMeth+" recType="+sRecType+" recKey="+sRecKey+" cust="+sCust);var oRec={};var oAuth={cust:sCust,user:sUser};if(sMeth=="Login"||sMeth=="ChangePassword"){oAuth.password=sRecType;sRecType=null}if(sToken)oAuth.token=sToken;if(sRecType&&sRecKey){oRec.KeyName=sCust+"/"+sRecType+"/"+sRecKey}if(!sRecType&&sRecKey){if(sMeth=="ChangePassword"){oRec.NewPassword=sRecKey}else{oRec.KeyName=sRecKey}}if(sDataFld)oRec.DataFld=sDataFld;var oJO={};var oExec={};oExec.ajaxMeth=sMeth;oExec.payload=oRec;oExec.auth=oAuth;oJO.EXEC=oExec;var sAjaxID="AngJS."+nAjaxID++;oJO.AjaxID=sAjaxID;return oJO}}]);oApp.factory("servTBL",["servGAE","servREC","servREG","servSess",function(servGAE,servREC,servREG,servSess){var oFuncs={};var oCurTP=null;oFuncs.setObjs=function(oTP,objs){servREC.setObjs(oTP,objs)};oFuncs.isCombined=function(oTP){return false};oFuncs.insertRec=function(oTP,obj,oaa,bInter){insertRec(oTP,obj,oaa,bInter)};return oFuncs;function insertRec(oTP,oRec,oaa,bIntermed){log("insertRec TBL mode "+oTP.recTitle,oRec);var oSave=angular.fromJson(angular.toJson(angular.copy(oRec)));delete oSave.oaa;var sDataFld=null;if(oSave.obj){sDataFld=angular.toJson(oSave.obj);delete oSave.obj}else{sDataFld=angular.toJson(oRec)}log("savedCopy TBL save=%o oTP=%o"+oTP.recTitle,oSave,oTP);var sKeyName=oSave.KeyName;if(sKeyName==null){var sFileKey=oTP.recName;if(oTP.fileKey)sFileKey=oTP.fileKey();sKeyName=servGAE.getCust()+"/"+oTP.recType+"/"+sFileKey;log("KeyName is "+sKeyName)}if(servSess.isSandboxMode()){var nIX=sKeyName.lastIndexOf("/");var sRecName=sKeyName.substring(nIX+1);var sParts=oTP.oCRUD.getAppStatKey();var sCache="."+sParts[2]+oTP.lsName+"-cache";log("update bypassed for sandboxMode key="+sKeyName+" "+sRecName+" "+sCache);if(localStorage[sCache]){var oNew=angular.fromJson(sDataFld);var oCache=JSON.parse(localStorage[sCache]);var oObj=oNew;if(oTP.cacheLoadExit)oObj=oTP.cacheLoadExit(sRecName,oNew);log("cache %o obj=%o",oCache,oObj);if(!oCache.map[sRecName]){oCache.map[sRecName]={GekID:"00000000",KeyName:sKeyName,UpdateTS:0};oTP.oObjs.push(oObj)}else{for(var i=0,iMax=oTP.oObjs.length;i<iMax;i+=1){var oO=oTP.oObjs[i];if(oO.name==oObj.name){oTP.oObjs[i]=oObj;log("found obj=%o oTP.objs=%o o=%o",oObj,{array:oTP.oObjs},oO);break}}}delete oTP.oCache;oTP.oCRUD.getObjs(oTP);oCache.map[sRecName].oObjs=oObj;localStorage[sCache]=angular.toJson(oCache);log("cacheUpdated cache=%o oTP.cache=%o obj=%o",oCache,{objs:oTP.oCache},oObj);oTP.oPrevSel=null;oTP.cycle=""+(new Date).getMilliseconds()}}else{servGAE.putKeyData(null,sKeyName,sDataFld,goodWrt,failWrt)}function goodWrt(){log("Record "+oTP.recTitle+" persisted OK intermed="+bIntermed);var oT=oTP.statTbl;if(oT.type=="table"&&!bIntermed){if(oT.lsName==null){var oTbl=servREG.findTable(oT.name);oTP.oCRUD.refreshNonCachedTable(oT,oTbl,oTP)}else{servGAE.issueFindFile(oTP.recType,"%",function(status,data){log("find good stat=%o data=%o",status,data);var oData={DataStat:{RECORD:data.RESULT.RECORD}};oTP.oCRUD.syncLocalData(null,servGAE.getToken(),oData)},function(status,data){log("find failed stat=%o data=%o",status,data)})}}}function failWrt(status,data){log("Record "+oTP.recTitle+" persist FAILED reason="+status,data);servSess.setErrorMsg("Update failed:"+data["status-message"])}}}]);oApp.factory("servREC",["$rootScope","servGAE",function($rootScope,servGAE){var oCRUD=null;var oFuncs={};var oCtrlEdit=null;oFuncs.setCRUD=function(crud){oCRUD=crud};oFuncs.isCombined=function(oTP){return true};oFuncs.setObjs=function(oTP,objs){setObjs(oTP,objs)};oFuncs.addChunk=function(oTP,objs,chunk){addChunk(oTP,objs,chunk)};oFuncs.reload=function(oTP){reload(oTP)};oFuncs.insertRec=function(oTP,obj,oaa,bInter){insertRec(oTP,obj,oaa,bInter)};oFuncs.saveRecords=function(oTP,oRecs,sRecName,sLSName,bRfsh){saveRecords(oTP,oRecs,sRecName,sLSName,bRfsh)};oFuncs.refreshSignal=function(sig,oTP){refreshSignal(sig,oTP)};oFuncs.hookCtrlEdit=function(ctrl){oCtrlEdit=ctrl};oFuncs.getCtrlEdit=function(){return oCtrlEdit};oFuncs.getOptions=function(oCol,bShort){return getOptions(oCol,bShort)};oFuncs.getModFld=function(oCol){return getModFld(oCol)};oFuncs.getMethods=function(oCol){return getMethods(oCol)};oFuncs.getColRows=function(oCol){return getColRows(oCol)};oFuncs.showListCol=function(oCol){return showListCol(oCol)};oFuncs.getProperties=function(oTP,oCol){return getProperties(oTP,oCol)};oFuncs.mapValue=function(oObj,oCol){return mapValue(oObj,oCol)};oFuncs.findCol=function(oTP,sCol){return findCol(oTP,sCol)};oFuncs.getTableCols=function(scope,oTP,sType){return getTableCols(scope,oTP,sType)};oFuncs.getSubRows=function(scope,oObj,oSchema){return getSubRows(scope,oObj,oSchema)};oFuncs.getSubCols=function(scope,schema,sType){return getSubCols(scope,schema,sType)};oFuncs.addProperty=function(oTP,oCol){return addProperty(oTP,oCol)};oFuncs.removeProperty=function(oTP,oCol,sName){return removeProperty(oTP,oCol,sName)};return oFuncs;function addProperty(oTP,oCol){var oObjEdit;if(!oCRUD.inEdit())return;var sName=prompt("Enter property name");if(sName==null)return;var bLoop=true;while(bLoop){var sAltName=null;oObjEdit=oCRUD.getObjEdit()||{};angular.forEach(oObjEdit[oCol.col],function(value,key){if(sName==key){sAltName=prompt("Name '"+sName+"' is not unique, try another");if(sAltName==null)bLoop=false}});if(!bLoop)return;if(sAltName==null)break;sName=sAltName}oObjEdit[oCol.col][sName]=""}function removeProperty(oTP,oCol,sName){if(!oCRUD.inEdit())return;var oObjEdit=oCRUD.getObjEdit()||{};delete oObjEdit[oCol.col][sName]}function mapValue(oObj,oCol){var sVal=oObj[oCol.col];if(typeof sVal=="undefined")return null;if(sVal=="null")return null;var oProp=oCol.oneOf;var sParts=oProp.col.split(":");var sCol=sParts[0];var oTP=oProp.table.getTabProp();if(!oTP.oMaps)oTP.oMaps={};if(!oTP.oMaps[sCol]){var oTagMap={};var oObjs=oTP.oCRUD.getObjs(oTP);for(var sVar in oObjs){var oRec=oObjs[sVar];oTagMap[oRec.tag]=oRec[sCol]}oTP.oMaps[sCol]=oTagMap}var sName=oTP.oMaps[sCol][sVal];if(!sName)sName="?"+sVal+"?";return sName}function getProperties(oTP,oCol){if(!oTP)return[];if(!oCRUD.inEdit())return[];if(oCol.type!="property")return[];var oNew=[];var sHide="";if(oCol.hide)sHide=","+oCol.hide+",";var oObjEdit=oCRUD.getObjEdit()||{};angular.forEach(oObjEdit[oCol.col],function(value,key){var bUse=true;if(sHide.indexOf(","+key+",")>=0)bUse=false;if(bUse)this.push(key)},oNew);return oNew}function showListCol(oCol){if(!("showList"in oCol))return true;return oCol.showList}function getTableCols(scope,oTP,sType){if(!oTP)return[];if(!oTP.cols)return[];return iterateCols(scope,oTP.cols,sType)}function getSubRows(scope,oObj,oSchema){if(!oObj)return[];if(!oObj[oSchema.base])return[];return oObj[oSchema.base]}function getSubCols(scope,schema,sType){if(!schema)return[];if(!schema.cols)return[];schema.cols=Col.asObjects(schema.cols);return iterateCols(scope,schema.cols,sType)}function iterateCols(scope,oColDefns,sType){var oCols=[];for(var i in oColDefns){var oCol=oColDefns[i];oCol.select(scope,oCols,sType)}return oCols}function getModFld(oCol){return"ng-model=oObj["+oCol.col+"]"}function getMethods(oCol){if(oCol.type!="list")return[];if(!oCol.methods)return[];return oCol.methods}function getColRows(oCol){if("rows"in oCol)return oCol.rows;return"-1"}function getOptions(oCol,bShort){var oProp=oCol.oneOf;if(!oProp)return[];var oTP=oProp.table.getTabProp();var oRecs=oTP.oCRUD.getObjs(oTP);log("options count="+oRecs.length+" col="+oCol.col);var oOpts=[];var sParts=oProp.col.split(":");if(!bShort){if("reqd"in oCol&&!oCol.reqd){oOpts.push({name:"--- not assigned ---",value:undefined})}}for(var i in oRecs){var oRec=oRecs[i];var oOpt={};oOpts.push(oOpt);if(sParts.length==1){oOpt.name=oRec[sParts[0]]}else{if(bShort){oOpt.name=oRec[sParts[0]];oOpt.title=oRec[sParts[1]]}else{oOpt.name=oRec[sParts[0]]+": "+oRec[sParts[1]]}}oOpt.value=+oRec.tag}return oOpts}function addChunk(oTP,objs,nChunk){oTP.oChunks[nChunk].oObjs=objs;refreshSignal("rs3",oTP);log("Loaded chunk "+nChunk+" objs="+objs.length+" ls="+oTP.oChunks[nChunk].ls)}function setObjs(oTP,objs){oTP.oObjs=objs;refreshSignal("rs4",oTP);log("loaded "+oTP.oObjs.length+" "+oTP.recTitle+" records(s) %o lsName=%s",{array:oTP.oObjs},oTP.lsName)}function getRawValue(oObj,oCol){if(oObj==null)return null;if(typeof oCol.col=="function")return oCol.col(oObj);return oObj[oCol.col]}function findCol(oTP,sCol){for(var i in oTP.cols){var oCol=oTP.cols[i];if(oCol.col===sCol)return oCol}return null}function maskReduce(oTP,oObjs,oSel,oFil){var oCol=findCol(oTP,oFil.field);if(oCol==null)return oObjs;var sMask=oSel[oFil.field];if(!sMask||""+sMask.trim()==="")return oObjs;var oMask=new RegExp(sMask,"i");var oNewObjs=[];for(var i in oObjs){var oRec=oObjs[i];var sFld=oCol.getValue(null,oRec);if((""+sFld).match(oMask)!=null){oNewObjs.push(oRec)}}return oNewObjs}function stateReduce(oTP,oObjs,oSel,oFil){var oCol=findCol(oTP,oFil.field);if(!oSel[oFil.field])return oObjs;var oStat=oSel[oFil.field].status;if(!oStat){log("no status field");return oObjs}if(oStat.open)return[];if(oStat.list.length===0)return oObjs;var oNewObjs=[];var oMap={};for(var j in oStat.list){var sVal=oStat.list[j];var sOptVal=oStat.tri[0].options[sVal].value;oMap[sOptVal]=true}for(var i in oObjs){var oRec=oObjs[i];var sFld=oRec[oFil.field];if(oStat.mode=="INCL"){if(oMap[sFld])oNewObjs.push(oRec)}else{if(!oMap[sFld])oNewObjs.push(oRec)}}return oNewObjs}function reload(oTP){if(oTP.oChunks){for(var i in oTP.oChunks){oTP.oChunks[i].oObjs=JSON.parse(localStorage[oTP.oChunks[i].ls]);log("reloaded "+oTP.recTitle+" chunk i="+i+" from  "+oTP.oChunks[i].ls+" objs="+oTP.oChunks[i].oObjs.length)}}else{if(oTP.lsName&&localStorage[oTP.lsName]){oTP.oObjs=JSON.parse(localStorage[oTP.lsName]);log("reloaded "+oTP.oObjs.length+" "+oTP.recTitle+" records(s) %o",{array:oTP.oObjs})}else{oTP.oObjs=[];log("reset oObjs "+oTP.recTitle)}}refreshSignal("rs5",oTP)}function removeObj(oObjs,oObj,nChunk){var oNew=[];for(var sVar in oObjs){var oRec=oObjs[sVar];if(oRec===oObj){log("Found "+oRec.tag+" "+oObj.tag+" chunk="+nChunk)}else{if(nChunk!=null){oRec.oaa=""+nChunk+"."+oNew.length}else{oRec.oaa=oNew.length}oNew.push(oRec)}}return oNew}function insertRec(oTP,oRec,oaa,bIntermed){var oRecs;log("insertRec REC mode rec=%o oaa=%s oTP=%o intermed=%s",oRec,oaa,oTP,bIntermed);var oSave=angular.fromJson(angular.toJson(angular.copy(oRec)));if(oTP.saveRecordExit)oSave=oTP.saveRecordExit(oSave);log("savedCopy %o",oSave);if(oTP.oChunks){var nChunk=oTP.oChunks.length-1;oRecs=null;var oChunk=oTP.oChunks[nChunk];if(oaa!=null){var sParts=oaa.split(".");nChunk=+sParts[0];oChunk=oTP.oChunks[nChunk];oRecs=oTP.oChunks[nChunk].oObjs;oSave.oaa=oaa;oRecs[sParts[1]]=oSave}else{oRecs=oChunk.oObjs;oSave.oaa=""+nChunk+"."+oRecs.length;oaa=oSave.oaa;oRecs.push(oSave)}if(!bIntermed)saveRecords(oTP,oRecs,oChunk.ls,oTP.lsName)}else{if(!oTP.oObjs)oTP.oObjs=[];oRecs=oTP.oObjs;if(oaa!=null){oSave.oaa=oaa;oRecs[oaa]=oSave}else{oSave.oaa=oRecs.length;oRecs.push(oSave)}var sFileKey=oTP.recName;if(oTP.fileKey)sFileKey=oTP.fileKey();if(!bIntermed)saveRecords(oTP,oRecs,sFileKey,oTP.lsName)}log("saved oaa="+oaa+" tag="+oSave.tag+" into "+oTP.recName);if(!bIntermed)refreshSignal("rs6",oTP)}function saveRecords(oTP,oRecs,sRecName,sLSName,bRefresh){log("Save records %s recName=%s lsName=%s count=%i refresh=%s",oTP.recTitle,sRecName,sLSName,oRecs.length,bRefresh);var sStr="";var sChar="[";var oSs=angular.fromJson(angular.toJson(oRecs));for(var sVar in oSs){var oRec=oSs[sVar];delete oRec.oaa;delete oRec.ix;sStr+=sChar+angular.toJson(oRec);sChar="\r\n,"}sStr+="]";if($rootScope.isSandboxMode()){var sParts=oCRUD.getAppStatKey();var sCache="."+sParts[2]+sLSName+"-cache";if(localStorage[sCache]){var oCache=JSON.parse(localStorage[sCache]);oCache.map[sRecName].oObjs=oRecs;localStorage[sCache]=angular.toJson(oCache);log("saveRecords sandboxMode recname=%s objs=%o lsName=%s cache=%o sLS=%s",sRecName,{array:oRecs},sLSName,oCache,sCache);if(bRefresh)refreshSignal("rsX",oTP)}}else{servGAE.putKeyData(oTP.recType,sRecName,sStr,goodWrt,failWrt)}function goodWrt(){log(""+oRecs.length+" record(s) on file "+oTP.recName+" persisted OK");if(bRefresh){refreshSignal("rsD",oTP);setTimeout(function(){$rootScope.$digest()
},0)}}function failWrt(){log(""+oRecs.length+" Record(s) on file "+oTP.recName+" persist FAILED")}}function refreshSignal(sSigID,oTP){log("refreshSignal id=%s tbl=%s",sSigID,oTP.recTitle,oTP);delete oTP.oMaps;delete oTP.oCache;oTP.oPrevSel=null;oTP.cycle=""+(new Date).getMilliseconds()}}]);function ctrlSect($scope,servSess,servGAE){log("Created ctrlSect");$scope.sPasswordErr=null;$scope.isSect=function(sSect){return servSess.isSect(sSect)};$scope.hasSession=function(){return servSess.hasSession()};$scope.hasErrorMsg=function(){return servSess.getErrorMsg()!=null};$scope.getErrorMsg=function(){return servSess.getErrorMsg()};$scope.closeErrorMsg=function(){return servSess.setErrorMsg(null)};$scope.hasConfirmMsg=function(){return servSess.getConfirmMsg()!=null};$scope.getConfirmMsg=function(){return servSess.getConfirmMsg()};$scope.closeConfirmMsg=function(){return servSess.setConfirmMsg(null)};$scope.cancelNewPassword=function(){servSess.setSect(null)};$scope.hasError=function(){return $scope.sPasswordErr!=null};$scope.submitNewPassword=function(){submitNewPassword()};function submitNewPassword(){setErr(null);if(!$scope.Password||$scope.Password.length===0){return setErr("Existing password required")}if(!$scope.NewPassword||$scope.NewPassword.length===0){return setErr("New password required")}if($scope.NewPassword.match(/[a-zA-Z]/)==null){return setErr("New password must contain at least one alphabetic character")}if($scope.NewPassword!=$scope.ConfirmPassword){return setErr("Repeated New password differs from New Password")}servGAE.changePassword($scope.Password,$scope.NewPassword,changeOK,changeFail);function changeOK(status,data){servSess.setConfirmMsg("Password change sucessful")}function changeFail(status,data){log("ChangeFailed",data);servSess.setErrorMsg("Password change failed:"+data.RESULT.CODE)}}function setErr(msg){$scope.sPasswordErr=msg}}function ctrlMenu($scope,$rootScope,servSess,servREG,servCRUD){log("Created ctrlMenu");servSess.hookIdleListener($scope);$rootScope.isTrue=function(b,sTrue,sFalse){return b?sTrue||"true":sFalse||"false"};$rootScope.getTitle=function(){return servSess.getTitle()};$rootScope.getSandboxMsg=function(){return servSess.getSandboxMsg()};$rootScope.isSandboxMode=function(){return servSess.isSandboxMode()};$scope.hasSession=function(){return servSess.hasSession()};$scope.canChangePassword=function(){return servSess.canChangePassword()};$scope.getUser=function(){return getUser()};$scope.getUser2=function(){return getUser2()};$scope.isAdmin=function(){return servSess.isAdmin()};$scope.getTables=function(){return getTables()};$scope.listService=function(tabdef){servSess.setSect("CommList",tabdef)};$scope.changePassword=function(){if(!servCRUD.inEdit())servSess.setSect("NewPassword",null)};$scope.getOptMenuItems=function(){return servSess.getOptMenuItems()};$scope.getActionClass=function(){if(servCRUD.inEdit())return"c-quiet";return"c-action"};$scope.logoff=function(){logoff()};$scope.pulse=function(){pulse()};$scope.getIdleSecs=function(){return servSess.getIdleSecs()};$scope.getIdleLeft=function(){return servSess.getIdleLeft()};$scope.autoLogoff=function(){autoLogoff()};function autoLogoff(){log("autoLogoff invoked");logoff();window.location.reload()}function logoff(){log("logoff invoked inEdit="+servCRUD.inEdit());servSess.setSession(false);servSess.setSect(null);delete localStorage[".user-token"]}function getUser(){if(!servSess.hasSession())return null;return" for "+servSess.getUser()}function getUser2(){if(!servSess.hasSession())return null;if(!servSess.isDouble())return"";var sUser2=servSess.getUser2()||"";if(sUser2.trim()!=="")return"/"+sUser2;return""}function pulse(){$scope.$digest()}function getTables(){var oTs=servREG.getTables();var oTabs=[];for(var i=0,iMax=oTs.length;i<iMax;i+=1){var oTab=oTs[i];var oTP=oTab.getTabProp();if(oTP.menuWhen){if(oTP.menuWhen())oTabs.push(oTab)}else{oTabs.push(oTab)}}return oTabs}}function ctrlSess($scope,$http,servSess,servGAE,servCRUD,servConfig){var fResume=null;var oCurTP=null;var sURL=""+window.location;log("URL:"+sURL);if(sURL.substring(0,7)=="file://"){servGAE.setURL("http://10.1.1.3:8884/gems/cita/ajax.ajax");servSess.setDevpMode()}else if(sURL.substring(0,17)=="http://localhost:"){servGAE.setURL(sURL.substring(0,21)+"/gems/cita/ajax.ajax");servSess.setDevpMode()}else{var nIX=sURL.indexOf("/cita/");servGAE.setURL(sURL.substring(0,nIX)+"/gems/cita/ajax.ajax")}$scope.sErrMsg="";$scope.sDouble="DOUBLE";$scope.UserName2="";$scope.Password2="";if(!$scope.UserName){var oFill=null;if(servConfig.getAutoFill)oFill=servConfig.getAutoFill();if(oFill){$scope.UserName=oFill.user;$scope.Password=oFill.password;$scope.UserName2="other";$scope.Password2="other"}}log("Created ctrlSess");$scope.login=function(sDbl){login(sDbl)};$scope.initUser=function(){initUser()};$scope.isSect=function(sSect){return servSess.isSect(sSect)};$scope.hasSession=function(){return servSess.hasSession()};$scope.sendReminder=function(){sendReminder()};function login(sDbl){log("login mode=%s scope=%o doing=%s",sDbl,$scope,$scope.bDoingLogin);if($scope.bDoingLogin)return;$scope.sErrMsg="";if(!$scope.UserName||$scope.UserName.trim().length===0){return loginError("Require username")}if(!$scope.Password||$scope.Password.trim().length===0){return loginError("Require password")}var xUser=$scope.UserName;var xPassword=$scope.Password;if(sDbl=="DOUBLE"){if(!$scope.UserName2||$scope.UserName2.trim().length===0){return loginError("Require 2nd username")}if(!$scope.Password2||$scope.Password2.trim().length===0){return loginError("Require 2nd password")}xUser={user1:xUser,password1:xPassword,user2:$scope.UserName2,password2:$scope.Password2};xPassword=null}if(angular.isDefined(window.ga))ga("send","event","action",sDbl=="DOUBLE"?"logindbl":"login",$scope.UserName);servSess.setUser(sDbl,$scope.UserName,$scope.UserName2);servGAE.login(xUser,xPassword,goodLogin,failLogin);$scope.bDoingLogin=true}function loginError(sMsg){$scope.sErrMsg=sMsg;if(angular.isDefined(window.ga))ga("send","event","action","loginerr",sMsg)}function sendReminder(){$scope.sErrMsg="";if(!$scope.UserName||$scope.UserName.trim().length===0){$scope.sErrMsg="Require username";return}servGAE.sendReminder($scope.UserName,good,fail);function good(){log("good reminder")}function fail(){log("failed reminder")}}function goodLogin(status,data){$scope.bDoingLogin=false;$scope.status=status;$scope.data=data;log("GoodLogin %o",data);var sToken=data.RESULT.token;servGAE.setToken(sToken);servSess.setSession(true,data.RESULT.PROFILE);servCRUD.syncLocalData($scope,sToken,data.RESULT)}function failLogin(status,data){log("FailLogin ");$scope.bDoingLogin=false;if(angular.isDefined(window.ga))ga("send","event","action","loginfail","server");$scope.data=data||"Request failed";$scope.status=status;if(data.RESULT&&data.RESULT.STATUS){$scope.sErrMsg="Login error status="+data.RESULT.STATUS+" code="+data.RESULT.CODE+" HTTP status:"+$scope.status}else{$scope.sErrMsg="Login Request error, HTTP status:"+$scope.status}}function initUser(){servSess.hasSession(false);if(servSess.getBootExit()!=null){servSess.getBootExit()();return}if(localStorage[".user"]){$scope.UserName=localStorage[".user"];$scope.UserName2=localStorage[".user2"];if(localStorage[".user-token"]){log("---------- Init user "+$scope.UserName+" token="+localStorage[".user-token"]);servGAE.validateToken($scope.UserName,localStorage[".user-token"],goodValidate,failValidate)}}else{log("---------- DUMMY Init user cycle");servGAE.validateToken("dummy","0",goodDummy,failDummy)}}function goodValidate(status,data){log("GoodValidate %o user1=%s user2=%s",data,$scope.UserName,$scope.UserName2);servSess.setSession(true,data.RESULT.PROFILE);var sDbl="SINGLE";if($scope.UserName2=="null")$scope.UserName2=null;if($scope.UserName2&&$scope.UserName2!=$scope.UserName)sDbl="DOUBLE";servSess.setUser(sDbl,$scope.UserName,$scope.UserName2);servCRUD.syncLocalData($scope,servGAE.getToken(),data.RESULT)}function failValidate(status,data){servGAE.setToken(null);log("Validate failed")}function goodDummy(status,data){log("dummy validate OK")}function failDummy(status,data){log("dummy validate failed")}}function ctrlCommList($scope,servSess,servREC,servCRUD){log("Created ctrlCommList");var nUsedCols=0;$scope.oSel={};servSess.hookListListener($scope);$scope.oServSess=servSess;$scope.isSect=function(sSect){return servSess.isSect(sSect)};$scope.hasSession=function(){return servSess.hasSession()};$scope.useTable=function(table,sel){return servSess.useTable($scope,table,sel)};$scope.getTableCols=function(type){return servREC.getTableCols($scope,$scope.getTabProp(),type)};$scope.showCol=function(oCol){return servREC.showListCol(oCol)?"true":"false"};$scope.initFilter=function(oFil){initFilter(oFil)};$scope.getColTitle=function(oFil){return getColTitle(oFil)};$scope.getRefColOpt=function(oFil){return getRefColOpt(oFil)};$scope.optionClick=function(oThis){return optionClick(oThis)};$scope.initOptions=function(oFil){return initOptions(oFil)};$scope.getBinding=function(oFil){return getBinding(oFil)};$scope.getFilters=function(sel,type){return getFilters(sel,type)};$scope.getFilter=function(fld){return getFilter(fld)};$scope.getColClass=function(ix,col){return getColClass(ix,col)};$scope.inEdit=function(){return servCRUD.inEdit()};$scope.inDlgEdit=function(){return servCRUD.inDlgEdit()};$scope.getObjs=function(){return servCRUD.getObjs()};$scope.getTabProp=function(){return servCRUD.getTabProp()};$scope.editRecord=function(oaa){servCRUD.editRecord(oaa)};$scope.makeRecord=function(){servCRUD.makeRecord()};$scope.dropRecord=function(oaa){servCRUD.dropRecord(oaa)};function getFilters(oSel,sType){var oFils=[];if(!oSel||!oSel._filters)return oFils;for(var i in oSel._filters){var oFil=oSel._filters[i];if(oFil.type==sType)oFils.push(oFil)}return oFils}function getFilter(sFld){var oFils=getFilters($scope.oSel,"state");for(var i in oFils){var oFil=oFils[i];if(oFil.field==sFld)return oFil}return null}function optionClick(oThis){log("option clicked ")}function getBinding(oFil){if(oFil.type!="state")return"";log("called get binding "+oFil.field+" "+oFil.type);var oSel=document.getElementById(oFil.field);log("called get binding "+oFil.field+" name="+oSel.name);return"<option>bind</option>"}function getColTitle(oFil){if(!oFil.field)return null;var oTP=getTabProp();if(oTP){var oCol=servREC.findCol(oTP,oFil.field);if(oCol)return oCol.getTitle()}return oFil.field}$scope.initSelect=function(oThis){return initSelect(oThis)};function initOptions(oFil){if(oFil.type!="state")return null;var oSel=document.getElementById(oFil.field);log("init select "+oFil.field+" "+oSel.name)}function getRefColOpt(oFil){if(oFil.type!="state")return[];var oCol=servREC.findCol(getTabProp(),oFil.field);if(!oCol)return[];if(!oCol.oneOf)return[];var oOpts=servREC.getOptions(oCol,true);log("return "+oOpts.length+" options "+oFil.field+" sel="+$scope.oSel);return oOpts}function initFilter(oFil){if(!oFil.init)return;if(!$scope.oSel)return;if(!(oFil.name in $scope.oSel))$scope.oSel[oFil.name]=oFil.init}function getColClass(ix,oCol){if(ix===0)nUsedCols=0;if(!$scope.showCol(oCol))return"Chide";nUsedCols+=1;return"C"+nUsedCols}}function ctrlCommEdit($scope,servSess,servREC,servCRUD){log("Created ctrlCommEdit");var nUsedCols=0;servCRUD.hookCtrlEdit($scope);$scope.oObj={};$scope.oPanel={};$scope.sEditErr=null;$scope.trigger=0;$scope.isSect=function(sSect){return servSess.isSect(sSect)};$scope.hasSession=function(){return servSess.hasSession()};$scope.useTable=function(table,sel){return servSess.useTable($scope,table,sel)};$scope.inEdit=function(){return servCRUD.inEdit()};$scope.inDlgEdit=function(){return servCRUD.inDlgEdit()};$scope.getEditType=function(){return servCRUD.getEditType()};$scope.getTabProp=function(){return servCRUD.getTabProp()};$scope.dirtyMsg=function(){return servCRUD.dirtyMsg($scope)};$scope.dirtyClass=function(){return servCRUD.dirtyClass($scope)};$scope.editCancel=function(){servCRUD.editCancel()};$scope.editSave=function(){servCRUD.editSave($scope)};$scope.hasEditError=function(){return $scope.sEditErr!=null};$scope.getTrimOpt=function(oCol){if(!("trim"in oCol))return"true";return oCol.trim?"true":"false"};$scope.isReadOnly=function(oCol){return isReadOnly(oCol)};$scope.getColClass=function(ix,col){return getColClass(ix,col)};$scope.isSelect=function(oCol){if("oneOf"in oCol)return"true";return"false"};$scope.getOptions=function(oCol){return servREC.getOptions(oCol)};$scope.getModFld=function(oCol){return servREC.getModFld(oCol)};$scope.getProperties=function(oCol){return servREC.getProperties($scope.getTabProp(),oCol)};$scope.isVirt=function(oCol){return oCol.type=="virt"};$scope.getTableCols=function(type){return servREC.getTableCols($scope,$scope.getTabProp(),type)};$scope.getSubRows=function(oObj,oSchema){return servREC.getSubRows($scope,oObj,oSchema)};$scope.getSubCols=function(schema,sType){return servREC.getSubCols($scope,schema,sType)};$scope.addProperty=function(oCol){return servREC.addProperty($scope.getTabProp(),oCol)};$scope.removeProperty=function(oCol,name){return servREC.removeProperty($scope.getTabProp(),oCol,name)};$scope.getMethods=function(oCol){return servREC.getMethods(oCol)};$scope.getColRows=function(oCol){return servREC.getColRows(oCol)};$scope.methodClick=function(oCol,oA,oObj,p){methodClick(oCol,oA,oObj,p)};$scope.showListCol=function(oCol){return servREC.showListCol(oCol)?"true":"false"};$scope.call=function(fn,oObj,x){return call(fn,oObj,x)};function isReadOnly(oCol){if($scope.isVirt(oCol))return"true";if(typeof oCol.readonly=="function")return oCol.readonly($scope,oCol);if("readonly"in oCol)return oCol.readonly?"true":"false";return"false"}function methodClick(oCol,x,oObj,parm){log("method click "+$scope.$id,x,parm);if(typeof x=="object"){x.method($scope.oObj,oCol,parm)}else{oCol.methods[x].method($scope,oObj,parm)}}function getColClass(ix,oCol){if(ix===0)nUsedCols=0;if(!$scope.showListCol(oCol))return"Chide";nUsedCols+=1;return"C"+nUsedCols}function call(fn,oObj,x){try{return fn($scope,oObj,x)}catch(e){log("call exception "+e)}}}if(!this.tri){this.tri={}}if(typeof tri.compiled==="undefined"){tri.compiled=true;tri.$templateCache=null;tri.postToOpener=function(oMsg){if(!window.opener){log("no window opener")}else{window.opener.postMessage(oMsg,"*")}};tri.loadTemplates=function($rootScope,$templateCache){tri.$templateCache=$templateCache;$rootScope.isTrue=tri.isTrue;var oNL=document.getElementsByClassName("for-template");for(var i=0,iMax=oNL.length;i<iMax;i+=1){var oDiv=angular.element(oNL[i]);var sHtml=oDiv.attr("html");var sVbl=oDiv.attr("ng-include");oDiv.attr("id","_"+sVbl);var scope=oDiv.scope();scope[sVbl]=null;log("Found %s %s",oDiv.attr("html"),oDiv.attr("ng-include"));tri.postToOpener({verb:"sys-get-template",payload:{name:sHtml,id:"_"+sVbl}})}};tri.postTemplate=function(event){var oPL=event.data.payload;var oDiv=angular.element(document.getElementById(oPL.id));var scope=oDiv.scope();var sName=oDiv.attr("ng-include");var oApp=angular.module("app");var sHtml=oPL.html;var sAlter=oDiv.attr("alter");if(sAlter)sHtml=tri.applyAlters(sHtml,sAlter);sHtml=tri.applyAlters(sHtml,"img-defer/img");log("GOT scope=%o name=%s app=%o",scope,sName,oApp);tri.$templateCache.put(oPL.name,sHtml);scope[sName]=oPL.name;scope.$digest()};tri.closePage=function(){log("closing page");tri.postToOpener({verb:"sys-close-page"})};tri.isTrue=function(b,sTrue,sFalse){return b?sTrue||"true":sFalse||"false"};tri.applyAlters=function(sHtml,sAlter){log("Apply alters "+sAlter);var sAlters=sAlter.split(";");for(var i=0,iMax=sAlters.length;i<iMax;i+=1){var sParts=[];if(sAlters[i].charAt(0)=="!"){sParts=sAlters[i].substring(1).split("!")}else{sParts=sAlters[i].split("/")}sHtml=sHtml.replace(new RegExp(sParts[0],"g"),sParts[1])}return sHtml};tri.calcAgo=function(sDate,sTime){var oNow=new Date;var mThen=Date.UTC(sDate.substring(0,4),+sDate.substring(4,6)-1,sDate.substring(6,8),sTime.substring(0,2),sTime.substring(2,4),sTime.substring(4,6),0);var nSecs=((oNow.getTime()-mThen)/1e3).toFixed(0);if(nSecs<60)return plural(nSecs,"sec");var nMins=(nSecs/60).toFixed(0);if(nMins<60)return plural(nMins,"min");var nHrs=(nMins/60).toFixed(0);if(nHrs<24)return plural(nHrs,"hr");var nDays=(nHrs/24).toFixed(0);if(nDays<7)return plural(nDays,"day");var nWks=(nDays/7).toFixed(0);if(nWks<4)return plural(nWks,"wk");var nMons=(nWks/4).toFixed(0);return plural(nMons,"mth");function plural(n,sStr){if(n>1)return""+n+" "+sStr+"s";return""+n+" "+sStr}}}